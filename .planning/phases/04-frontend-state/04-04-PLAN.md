---
phase: 04-frontend-state
plan: 04
type: execute
wave: 2
depends_on: ["04-03"]
files_modified:
  - src/components/features/kpi/kpi-tree-widget.tsx
  - src/app/(dashboard)/vision/[id]/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Completing a KPI shows updated progress immediately before server confirms"
    - "Failed updates roll back to previous state with clear error message"
    - "Loading states clearly indicate when progress is being recalculated"
  artifacts:
    - path: "src/components/features/kpi/kpi-tree-widget.tsx"
      provides: "Minimal component using useGoalTree and useLogKpi hooks"
      min_lines: 60
      exports: ["KpiTreeWidget"]
    - path: "src/app/(dashboard)/vision/[id]/page.tsx"
      provides: "Vision detail page rendering KpiTreeWidget"
      contains: "KpiTreeWidget"
  key_links:
    - from: "kpi-tree-widget.tsx"
      to: "use-goal-tree.ts"
      via: "import { useGoalTree }"
      pattern: "useGoalTree"
    - from: "kpi-tree-widget.tsx"
      to: "use-kpi-mutations.ts"
      via: "import { useLogKpi }"
      pattern: "useLogKpi"
    - from: "kpi-tree-widget.tsx"
      to: "sonner"
      via: "toast.error for failed updates"
      pattern: "toast\\.error"
---

<objective>
Create minimal KPI tree widget that wires up the React Query hooks to prove optimistic updates work.

Purpose: The hooks exist but are orphaned. This component imports and uses them, demonstrating optimistic updates, rollback on error, and loading states. Phase 6 will build the full tree UI.

Output: Working KpiTreeWidget component integrated into vision detail page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-frontend-state/04-01-SUMMARY.md
@.planning/phases/04-frontend-state/04-02-SUMMARY.md

**Existing patterns to follow:**
- src/components/features/kpi/daily-kpi-checkoff.tsx - Shows checkbox pattern with toast
- src/components/ui/checkbox.tsx - Shadcn checkbox component
- Sonner toast via `import { toast } from 'sonner'`

**Hooks available:**
- useGoalTree(visionId) - Returns { data, isLoading, isUpdating, error }
- useLogKpi(visionId) - Returns { mutate, isPending, isLoggingKpi, error }

**SCOPE LIMIT:** This is NOT the full tree UI. Phase 6 handles collapsible nodes, breadcrumbs, status indicators. This is a MINIMAL proof that hooks work:
- Flat list of KPIs (no tree nesting needed)
- Checkbox to toggle completion
- Progress bar per KPI
- Loading and error states
- Toast on error
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KpiTreeWidget component</name>
  <files>src/components/features/kpi/kpi-tree-widget.tsx</files>
  <action>
    Create a minimal component that:

    1. Imports from hooks: `import { useGoalTree, useLogKpi } from '@/lib/hooks'`
    2. Imports toast: `import { toast } from 'sonner'`
    3. Imports UI: Checkbox, Progress, Skeleton from shadcn

    4. Component signature:
    ```tsx
    interface KpiTreeWidgetProps {
      visionId: string;
    }
    export function KpiTreeWidget({ visionId }: KpiTreeWidgetProps)
    ```

    5. Hook usage:
    ```tsx
    const { data, isLoading, isUpdating, error } = useGoalTree(visionId);
    const { mutate: logKpi, isLoggingKpi, error: mutationError } = useLogKpi(visionId, {
      onError: (err) => toast.error(`Failed to update: ${err.message}`),
    });
    ```

    6. Render states:
    - isLoading: Show skeleton cards (3-4 placeholder items)
    - error: Show error message with retry button
    - isUpdating: Show subtle "Updating..." indicator at top
    - data: Render flat list of KPIs from tree (flatten with helper function)

    7. Each KPI item shows:
    - Checkbox (checked if progress >= 100)
    - Title
    - Progress bar (0-100)
    - isPending state on checkbox

    8. Checkbox onChange calls:
    ```tsx
    logKpi({ kpiId: kpi.id, isCompleted: !isCompleted });
    ```

    9. Helper function to flatten tree:
    ```tsx
    function flattenTree(nodes: KpiTreeNode[]): KpiTreeNode[] {
      return nodes.flatMap(n => [n, ...flattenTree(n.children || [])]);
    }
    ```

    Keep it simple - no collapsible tree, no fancy styling. Just enough to prove the hooks work.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes
    2. File exists with useGoalTree and useLogKpi imports
    3. Component exports KpiTreeWidget
  </verify>
  <done>KpiTreeWidget component created with hook integration and error handling</done>
</task>

<task type="auto">
  <name>Task 2: Add KpiTreeWidget to vision detail page</name>
  <files>src/app/(dashboard)/vision/[id]/page.tsx</files>
  <action>
    1. Read the existing vision detail page
    2. Import KpiTreeWidget: `import { KpiTreeWidget } from '@/components/features/kpi/kpi-tree-widget'`
    3. Add a section after existing content (likely after the vision details):

    ```tsx
    <section className="mt-8">
      <h2 className="text-xl font-semibold mb-4">KPI Progress</h2>
      <KpiTreeWidget visionId={id} />
    </section>
    ```

    4. The visionId should come from the page params (already available as `id`)

    If the page uses a client component pattern, ensure KpiTreeWidget is included inside the client boundary.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes
    2. Grep confirms import: `grep -n "KpiTreeWidget" src/app/(dashboard)/vision/[id]/page.tsx`
    3. Dev server shows widget on vision detail page (manual check by user in Phase 6)
  </verify>
  <done>Vision detail page renders KpiTreeWidget with visionId prop</done>
</task>

</tasks>

<verification>
- [ ] TypeScript compiles without errors
- [ ] KpiTreeWidget imports useGoalTree and useLogKpi
- [ ] KpiTreeWidget displays loading skeleton when isLoading
- [ ] KpiTreeWidget shows toast on mutation error
- [ ] Vision detail page imports and renders KpiTreeWidget
- [ ] No console errors on page load
</verification>

<success_criteria>
User can visit /vision/[id], see list of KPIs with checkboxes and progress bars.
Checking a KPI immediately shows it as complete (optimistic update).
If server fails, toast shows error and checkbox reverts (rollback).
Loading spinner shows during initial fetch and updates.
</success_criteria>

<output>
After completion, create `.planning/phases/04-frontend-state/04-04-SUMMARY.md`
</output>
