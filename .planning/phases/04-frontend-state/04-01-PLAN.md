---
phase: 04-frontend-state
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/hooks/use-goal-tree.ts
  - src/lib/hooks/use-kpi-mutations.ts
  - src/lib/hooks/index.ts
autonomous: true

must_haves:
  truths:
    - "useGoalTree hook fetches and returns nested KPI hierarchy for a vision"
    - "useLogKpi mutation posts log and returns updated ancestor progress"
    - "Optimistic update shows new progress before server confirms"
    - "Failed mutation rolls back to previous state"
    - "Error message is accessible from mutation state"
  artifacts:
    - path: "src/lib/hooks/use-goal-tree.ts"
      provides: "React Query hook for goal tree fetching"
      exports: ["useGoalTree"]
    - path: "src/lib/hooks/use-kpi-mutations.ts"
      provides: "React Query mutations with optimistic updates"
      exports: ["useLogKpi", "useOverrideProgress"]
    - path: "src/lib/hooks/index.ts"
      provides: "Barrel export for hooks"
      contains: "useGoalTree"
  key_links:
    - from: "src/lib/hooks/use-goal-tree.ts"
      to: "/api/goal-tree/{visionId}"
      via: "fetch in queryFn"
      pattern: "fetch.*api/goal-tree"
    - from: "src/lib/hooks/use-kpi-mutations.ts"
      to: "/api/vision-kpis/{id}/log"
      via: "fetch in mutationFn"
      pattern: "fetch.*api/vision-kpis"
---

<objective>
Create React Query hooks for goal tree fetching and KPI mutations with optimistic updates.

Purpose: Provide instant UI feedback when users complete KPIs by optimistically updating progress before server confirms, with rollback on error.

Output: Two new hook files (use-goal-tree.ts, use-kpi-mutations.ts) and updated barrel export.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# API endpoints from Phase 3
@src/app/api/goal-tree/[visionId]/route.ts
@src/app/api/vision-kpis/[id]/log/route.ts

# Types from progress library
@src/lib/progress/tree.ts
@src/lib/progress/types.ts
@src/lib/progress/ancestor-rollup.ts

# Existing React Query patterns
@src/app/(dashboard)/goals/page.tsx
@src/components/providers.tsx

# Existing hooks directory structure
@src/lib/hooks/use-time-blocks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useGoalTree hook</name>
  <files>src/lib/hooks/use-goal-tree.ts</files>
  <action>
Create a new React Query hook for fetching the goal tree hierarchy.

The hook must:
1. Accept visionId as parameter (string)
2. Use useQuery from @tanstack/react-query
3. Return the goal tree API response shape: { visionId, tree: KpiTreeNode[], metadata }
4. Handle loading, error, and refetch states
5. Use query key pattern: ['goalTree', visionId]
6. Include enabled option to skip fetching when visionId is undefined/empty

Type imports:
- Import KpiTreeNode from '@/lib/progress'

Response type (match API):
```typescript
interface GoalTreeResponse {
  visionId: string;
  tree: KpiTreeNode[];
  metadata: {
    totalKpis: number;
    lastCalculated: string | null;
    duration: number;
  };
}
```

Hook signature:
```typescript
export function useGoalTree(visionId: string | undefined) {
  // Returns UseQueryResult<GoalTreeResponse, Error>
}
```

Follow the pattern from use-time-blocks.ts but use React Query instead of useState for data management.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
File exists with correct exports: `grep -l "useGoalTree" src/lib/hooks/use-goal-tree.ts`
  </verify>
  <done>
useGoalTree hook exported and compiles. Takes visionId, returns query result with tree data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useLogKpi mutation with optimistic updates</name>
  <files>src/lib/hooks/use-kpi-mutations.ts</files>
  <action>
Create React Query mutations for KPI logging with optimistic updates.

The hook must:
1. Use useMutation from @tanstack/react-query
2. Implement optimistic update in onMutate:
   - Snapshot previous tree state using queryClient.getQueryData
   - Calculate new progress locally (simple: set logged KPI to 100% if completed)
   - Update cache with queryClient.setQueryData
3. Implement rollback in onError:
   - Restore snapshot on failure
4. Implement cache sync in onSettled:
   - Optionally invalidate or update with server response
5. Accept callbacks: onSuccess, onError

Type imports:
- Import AncestorProgressUpdate from '@/lib/progress'
- Import KpiTreeNode from '@/lib/progress'

Log API request type:
```typescript
interface LogKpiRequest {
  kpiId: string;
  date?: string;
  value?: number;
  isCompleted?: boolean;
  notes?: string;
}
```

Log API response type (from 03-02):
```typescript
interface LogKpiResponse {
  log: {
    id: string;
    kpi_id: string;
    log_date: string;
    value: number | null;
    is_completed: boolean;
    notes: string | null;
  };
  rollup: {
    updatedKpis: AncestorProgressUpdate[];
    duration: number;
  };
}
```

Hook signature:
```typescript
export function useLogKpi(visionId: string | undefined) {
  // Returns UseMutationResult with optimistic updates
}
```

Optimistic update logic:
1. In onMutate, find the KPI in the tree and its ancestors
2. Set logged KPI progress to 100 if isCompleted
3. Update all ancestor progress values using the updatedKpis from response (or estimate locally)
4. Store previous tree state for rollback

Also create useOverrideProgress hook for manual override mutations:
- POST to /api/kpi-progress/{id}/override
- Same optimistic pattern
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
File exports both hooks: `grep -E "export function use(LogKpi|OverrideProgress)" src/lib/hooks/use-kpi-mutations.ts`
  </verify>
  <done>
useLogKpi and useOverrideProgress hooks exported. Mutations implement optimistic updates with rollback on error.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update hooks barrel export</name>
  <files>src/lib/hooks/index.ts</files>
  <action>
Create or update the hooks barrel export file to include new goal tree hooks.

Add exports:
```typescript
export { useGoalTree } from './use-goal-tree';
export { useLogKpi, useOverrideProgress } from './use-kpi-mutations';
```

If index.ts doesn't exist, create it with all hook exports.
If it exists, add the new exports while preserving existing ones.

Check what already exists:
- If no index.ts, create with exports for use-goal-tree and use-kpi-mutations only (other hooks may have their own import patterns)
  </action>
  <verify>
File exists: `ls src/lib/hooks/index.ts`
Exports new hooks: `grep -E "useGoalTree|useLogKpi" src/lib/hooks/index.ts`
  </verify>
  <done>
Barrel export file exists and exports useGoalTree, useLogKpi, useOverrideProgress.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. New files exist:
   - src/lib/hooks/use-goal-tree.ts
   - src/lib/hooks/use-kpi-mutations.ts
   - src/lib/hooks/index.ts (or updated)
3. Exports are correct:
   - `grep "useGoalTree" src/lib/hooks/use-goal-tree.ts`
   - `grep "useLogKpi" src/lib/hooks/use-kpi-mutations.ts`
</verification>

<success_criteria>
1. useGoalTree hook fetches goal tree from /api/goal-tree/{visionId}
2. useLogKpi mutation posts to /api/vision-kpis/{id}/log with optimistic updates
3. Failed mutations roll back cache to previous state
4. Error state accessible from mutation result
5. All files compile with TypeScript
</success_criteria>

<output>
After completion, create `.planning/phases/04-frontend-state/04-01-SUMMARY.md`
</output>
