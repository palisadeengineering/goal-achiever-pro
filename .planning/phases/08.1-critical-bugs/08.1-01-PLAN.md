# Plan 08.1-01: Critical Bug Fixes

## Objective

Fix critical bugs that break core functionality before adding new features. These bugs must be resolved for the app to be usable for beta testing.

## Execution Context

**Phase**: 8.1 - Critical Bug Fixes (INSERTED - urgent)
**Depends on**: v1.0 complete
**Scope**: ~100 lines of fixes across 4 areas

**Reference files**:
- `src/app/(dashboard)/time-audit/projects/page.tsx` - color crash
- `src/app/(dashboard)/settings/subscription/page.tsx` - undefined price
- `src/lib/stripe/config.ts` - pricing tier definitions
- Multiple files with "Power Goals" terminology

## Context

**Bugs identified**:
1. Time Audit crash - `project.color` accessed without null check
2. Subscription shows "$undefined/month" - tier mismatch with PRICING_TIERS
3. KPIs not connected to backtrack plan metrics (separate investigation needed)
4. "Power Goals" terminology in 12+ locations should be "Impact Projects"

## Tasks

### Task 1: Fix Time Audit color crash
**File**: `src/app/(dashboard)/time-audit/projects/page.tsx`
**Issue**: Lines 166, 356, 360 access `project.color` without null checking
**Action**: Add null-safe fallbacks

```typescript
// Line 166 - setEditColor
setEditColor(project.color || '#6b7280');

// Line 356 - backgroundColor
style={{ backgroundColor: (project.color || '#6b7280') + '20' }}

// Line 360 - color
style={{ color: project.color || '#6b7280' }}
```

Also add a default color constant at the top of the file:
```typescript
const DEFAULT_PROJECT_COLOR = '#6b7280'; // gray-500
```

### Task 2: Fix subscription undefined price display
**File**: `src/app/(dashboard)/settings/subscription/page.tsx`
**Issue**: `currentTier` can be undefined if tier doesn't match PRICING_TIERS ids
**Action**: Add fallback handling

```typescript
// Around line 65, after currentTier definition:
const currentTier = PRICING_TIERS.find(t => t.id === subscription.tier) || PRICING_TIERS[0];

// Line 162-167: Add safer display
<p className="text-2xl font-bold">{currentTier?.name || 'Free'}</p>
<p className="text-muted-foreground">
  {currentTier?.monthlyPrice === 0 || !currentTier
    ? 'Free forever'
    : `$${currentTier.monthlyPrice}/month`}
</p>
```

### Task 3: Fix remaining "Power Goals" terminology
**Files to update**:

| File | Line | Change |
|------|------|--------|
| `src/app/api/visions/[id]/generate-cascade/route.ts` | 206 | "Power Goals" → "Impact Projects" |
| `src/app/api/visions/[id]/generate-cascade/route.ts` | 679 | "Power Goals" → "Impact Projects" |
| `src/app/api/visions/[id]/generate-cascade/route.ts` | 680 | "Power Goals" → "Impact Projects" |
| `src/components/features/vision/wizard-steps/strategic-discovery-step.tsx` | 229 | "Power Goals" → "Impact Projects" |
| `src/components/features/vision/wizard-steps/strategic-discovery-step.tsx` | 238 | "Power Goals" → "Impact Projects" |
| `src/app/api/ai/strategic-discovery/route.ts` | 94 | "Power Goals" → "Impact Projects" |
| `src/lib/db/schema.ts` | 150 | Comment: "Power Goals" → "Impact Projects" |
| `src/app/api/ai/generate-backtrack/route.ts` | 202 | "Power Goals" → "Impact Projects" |
| `src/app/api/ai/generate-backtrack/route.ts` | 228 | "Power Goals" → "Impact Projects" |
| `src/app/api/ai/generate-projects/route.ts` | 55 | "Power Goals" → "Impact Projects" |
| `src/app/api/ai/generate-projects/route.ts` | 67 | "Power Goals" → "Impact Projects" |
| `src/lib/email/templates/beta-invitation.ts` | 33 | "Power Goals" → "Impact Projects" |
| `src/lib/email/templates/welcome.ts` | 43 | "Power Goals" → "Impact Projects" |

**Action**: Use find/replace in each file, preserving case

### Task 4: Investigate KPI-to-backtrack connection
**Issue**: Backtrack plan generates quarterly targets with `keyMetric` and `targetValue`, but KPIs tab shows "No KPIs Yet"
**Investigation needed**:

1. Check if `generate-cascade` creates vision_kpis entries
2. Check if backtrack plan metrics map to KPIs
3. Verify the data flow: backtrack → quarterly_targets → vision_kpis

**Files to examine**:
- `src/app/api/visions/[id]/generate-cascade/route.ts`
- `src/app/api/backtrack/route.ts`
- KPIs tab component (find via grep)

**Expected outcome**: Either fix the connection or document that KPI auto-generation from backtrack is a new feature for Phase 9+

## Verification

1. **Time Audit**: Navigate to `/time-audit/projects` - page loads without crash
2. **Subscription**: Navigate to `/settings/subscription` - shows valid price (not $undefined)
3. **Terminology**: Search codebase for "Power Goals" - should return 0 results in src/
4. **Build**: `npm run build` passes without errors

## Success Criteria

- [ ] Time Audit projects page loads without crash (even with projects missing color)
- [ ] Subscription page displays valid pricing for all tier states
- [ ] All user-facing "Power Goals" references changed to "Impact Projects"
- [ ] KPI connection issue documented or fixed
- [ ] Build passes

## Output

After completing this plan:
- App is stable and usable for beta testing
- Terminology is consistent throughout
- KPI issue either resolved or documented for future phase
- Ready to proceed with Phase 9 gamification work
