---
phase: 05-cascade-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/visions/[id]/generate-cascade/route.ts
autonomous: true

must_haves:
  truths:
    - "Generated KPIs have parent_kpi_id set correctly forming hierarchy"
    - "Quarterly KPIs are roots (no parent)"
    - "Monthly KPIs link to their quarterly parent"
    - "Weekly KPIs link to their monthly parent"
    - "Daily KPIs link to their weekly parent"
  artifacts:
    - path: "src/app/api/visions/[id]/generate-cascade/route.ts"
      provides: "AI cascade generation with proper parent linkage"
      contains: "parent_kpi_id"
  key_links:
    - from: "src/app/api/visions/[id]/generate-cascade/route.ts"
      to: "vision_kpis table"
      via: "supabase insert with parent_kpi_id"
      pattern: "parent_kpi_id.*savedQuarterlyKpi"
---

<objective>
Fix the existing generate-cascade endpoint to properly set parent_kpi_id when creating KPIs, establishing the hierarchical relationships needed for progress rollup.

Purpose: The existing endpoint creates KPIs but leaves them flat (no parent links). This breaks the progress cascade since child KPIs don't roll up to parents. This plan fixes that by:
1. Creating quarterly KPIs first (as roots)
2. Linking monthly KPIs to their quarterly parent
3. Linking weekly KPIs to their monthly parent
4. Linking daily KPIs to their weekly parent

**Scope clarification:** This plan handles backend cascade generation only. UI integration (triggering generation from Vision form) is part of Phase 6's tree UI work.

Output: Modified generate-cascade endpoint that creates properly linked KPI hierarchy
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/api/visions/[id]/generate-cascade/route.ts
@src/lib/db/schema.ts (vision_kpis table definition with parent_kpi_id)
@src/lib/progress/rollup.ts (progress rollup functions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor generate-cascade to link KPIs hierarchically</name>
  <files>src/app/api/visions/[id]/generate-cascade/route.ts</files>
  <action>
Modify the POST handler to create KPIs with proper parent_kpi_id linkage:

1. **Create quarterly KPIs first and capture their IDs:**
   - When creating a quarterly KPI, capture the returned `id`
   - Store in a map: `quarterlyKpiMap[quarter] = savedQuarterlyKpi.id`

2. **Link monthly KPIs to quarterly parents:**
   - When inserting monthly KPI, add `parent_kpi_id: quarterlyKpiMap[pg.quarter]`
   - Capture monthly KPI id: `monthlyKpiMap[`${pg.quarter}-${mt.month}`] = savedMonthlyKpi.id`

3. **Link weekly KPIs to monthly parents:**
   - When inserting weekly KPI, add `parent_kpi_id: monthlyKpiMap[`${pg.quarter}-${mt.month}`]`
   - Capture weekly KPI id: `weeklyKpiMap[`${pg.quarter}-${mt.month}-${wt.weekNumber}`] = savedWeeklyKpi.id`

4. **Link daily KPIs to weekly parents:**
   - The daily KPIs created from `cascadeData.dailyKpis` (global habits) should NOT have parents (they're standalone habits)
   - But we should add new daily KPIs derived from weekly KPIs with parent links

5. **Key changes to make:**
   - Add `.select('id')` to quarterly KPI insert to get the id
   - Add `.select('id')` to monthly KPI insert
   - Add `.select('id')` to weekly KPI insert
   - Pass `parent_kpi_id` when inserting child KPIs

**Note:** Progress cache initialization for newly created KPIs is handled in Task 2.

Example code pattern:
```typescript
// Create quarterly KPI and capture ID
const { data: savedQuarterlyKpi, error: qkError } = await supabase
  .from('vision_kpis')
  .insert({
    user_id: userId,
    vision_id: visionId,
    level: 'quarterly',
    quarter: pg.quarter,
    title: pg.quarterlyKpi.title,
    // ... other fields
  })
  .select('id')
  .single();

const quarterlyKpiId = savedQuarterlyKpi?.id;

// Create monthly KPI linked to quarterly
const { data: savedMonthlyKpi, error: mkError } = await supabase
  .from('vision_kpis')
  .insert({
    user_id: userId,
    vision_id: visionId,
    level: 'monthly',
    parent_kpi_id: quarterlyKpiId, // <-- Link to parent
    // ... other fields
  })
  .select('id')
  .single();
```
  </action>
  <verify>
1. Read the modified route.ts file
2. Confirm `parent_kpi_id` is passed in monthly, weekly KPI inserts
3. Confirm `.select('id')` is added to quarterly, monthly, weekly KPI inserts
4. Run `npx tsc --noEmit` to verify TypeScript compiles
  </verify>
  <done>
Generate-cascade endpoint creates KPIs with proper parent_kpi_id links:
- Quarterly KPIs have no parent (root nodes)
- Monthly KPIs link to their quarter's KPI
- Weekly KPIs link to their month's KPI
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Initialize progress cache for newly created KPIs</name>
  <files>src/app/api/visions/[id]/generate-cascade/route.ts</files>
  <action>
After creating each KPI, initialize its progress cache entry so the progress rollup system works immediately.

Add helper function at the end of the file:
```typescript
async function initializeKpiProgressCache(
  supabase: SupabaseClient,
  kpiId: string,
  numericTarget: number | null
): Promise<void> {
  await supabase
    .from('kpi_progress_cache')
    .upsert({
      kpi_id: kpiId,
      current_value: 0,
      target_value: numericTarget,
      progress_percentage: 0,
      child_count: 0,
      completed_child_count: 0,
      weighted_progress: 0,
      total_weight: 1,
      status: 'not_started',
      calculation_method: 'auto',
      last_calculated_at: new Date().toISOString(),
    }, { onConflict: 'kpi_id' });
}
```

Call this function after each successful KPI insert:
```typescript
if (savedQuarterlyKpi?.id) {
  await initializeKpiProgressCache(supabase, savedQuarterlyKpi.id, parseFloat(pg.quarterlyKpi.targetValue) || null);
}
```

This ensures:
1. Progress cache exists for all KPIs from creation
2. Initial status is 'not_started'
3. Rollup calculations work immediately
  </action>
  <verify>
1. Read the modified route.ts file
2. Confirm initializeKpiProgressCache helper exists
3. Confirm it's called after each KPI insert (quarterly, monthly, weekly, daily)
4. Run `npx tsc --noEmit` to verify TypeScript compiles
  </verify>
  <done>
Progress cache is initialized for each KPI upon creation:
- Helper function initializeKpiProgressCache exists
- Called after quarterly, monthly, weekly KPI inserts
- Sets initial status to 'not_started' with 0% progress
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Code review confirms parent_kpi_id linkage pattern
3. Progress cache initialization exists for all KPI types
</verification>

<success_criteria>
1. Generate-cascade creates KPIs with proper parent_kpi_id hierarchy
2. Quarterly KPIs are roots (parent_kpi_id is null)
3. Monthly/weekly KPIs have parent_kpi_id set to their parent
4. Progress cache is initialized for each KPI
5. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-cascade-generation/05-01-SUMMARY.md`
</output>
