---
phase: 05-cascade-generation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/vision-kpis/route.ts
  - src/lib/hooks/use-kpi-mutations.ts
autonomous: true

must_haves:
  truths:
    - "User can create a KPI and link it to any parent"
    - "User can create root-level KPIs (no parent)"
    - "Created KPIs appear in the goal tree immediately"
    - "Frontend can call mutation to create KPIs"
  artifacts:
    - path: "src/app/api/vision-kpis/route.ts"
      provides: "POST endpoint for manual KPI creation"
      exports: ["POST"]
    - path: "src/lib/hooks/use-kpi-mutations.ts"
      provides: "useCreateKpi mutation hook"
      contains: "useCreateKpi"
  key_links:
    - from: "src/lib/hooks/use-kpi-mutations.ts"
      to: "/api/vision-kpis"
      via: "fetch POST"
      pattern: "fetch.*api/vision-kpis"
    - from: "src/app/api/vision-kpis/route.ts"
      to: "vision_kpis table"
      via: "supabase insert"
      pattern: "supabase.*from.*vision_kpis.*insert"
---

<objective>
Create API endpoint and React hook for manual KPI creation with parent linkage.

Purpose: Users need to manually create KPIs and link them to existing parents in the hierarchy. This enables:
- Creating custom KPIs that AI didn't generate
- Linking new KPIs to any level in the hierarchy
- Building custom sub-hierarchies under existing KPIs

Output: POST /api/vision-kpis endpoint + useCreateKpi mutation hook
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/hooks/use-kpi-mutations.ts (existing mutations to extend)
@src/lib/hooks/query-keys.ts (query key factory)
@src/app/api/vision-kpis/[id]/route.ts (existing KPI routes pattern)
@src/lib/db/schema.ts (vision_kpis table)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create POST endpoint for manual KPI creation</name>
  <files>src/app/api/vision-kpis/route.ts</files>
  <action>
Create a new route file at `src/app/api/vision-kpis/route.ts` with a POST handler for creating KPIs.

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { getAuthenticatedUser } from '@/lib/auth/api-auth';

interface CreateKpiBody {
  visionId: string;
  title: string;
  description?: string;
  level: 'quarterly' | 'monthly' | 'weekly' | 'daily';
  parentKpiId?: string | null;
  targetValue?: string;
  unit?: string;
  numericTarget?: number;
  weight?: number;
  quarter?: number;
  month?: number;
}

// POST: Create a new KPI manually
export async function POST(request: NextRequest) {
  try {
    const auth = await getAuthenticatedUser();
    if (!auth.isAuthenticated) {
      return NextResponse.json({ error: auth.error }, { status: auth.status });
    }
    const userId = auth.userId;

    const body: CreateKpiBody = await request.json();

    // Validate required fields
    if (!body.visionId || !body.title || !body.level) {
      return NextResponse.json(
        { error: 'visionId, title, and level are required' },
        { status: 400 }
      );
    }

    // Validate level
    const validLevels = ['quarterly', 'monthly', 'weekly', 'daily'];
    if (!validLevels.includes(body.level)) {
      return NextResponse.json(
        { error: 'level must be one of: quarterly, monthly, weekly, daily' },
        { status: 400 }
      );
    }

    const supabase = await createClient();
    if (!supabase) {
      return NextResponse.json({ error: 'Database connection failed' }, { status: 500 });
    }

    // Verify vision belongs to user
    const { data: vision, error: visionError } = await supabase
      .from('visions')
      .select('id')
      .eq('id', body.visionId)
      .eq('user_id', userId)
      .single();

    if (visionError || !vision) {
      return NextResponse.json({ error: 'Vision not found' }, { status: 404 });
    }

    // If parentKpiId provided, verify it exists and belongs to same vision
    if (body.parentKpiId) {
      const { data: parentKpi, error: parentError } = await supabase
        .from('vision_kpis')
        .select('id, vision_id')
        .eq('id', body.parentKpiId)
        .single();

      if (parentError || !parentKpi) {
        return NextResponse.json({ error: 'Parent KPI not found' }, { status: 404 });
      }

      if (parentKpi.vision_id !== body.visionId) {
        return NextResponse.json(
          { error: 'Parent KPI must belong to the same vision' },
          { status: 400 }
        );
      }
    }

    // Create the KPI
    const { data: newKpi, error: createError } = await supabase
      .from('vision_kpis')
      .insert({
        user_id: userId,
        vision_id: body.visionId,
        title: body.title,
        description: body.description || null,
        level: body.level,
        parent_kpi_id: body.parentKpiId || null,
        target_value: body.targetValue || null,
        unit: body.unit || null,
        numeric_target: body.numericTarget || null,
        weight: body.weight || 1,
        quarter: body.quarter || null,
        month: body.month || null,
        is_active: true,
        sort_order: 0,
      })
      .select('*')
      .single();

    if (createError || !newKpi) {
      console.error('Error creating KPI:', createError);
      return NextResponse.json(
        { error: 'Failed to create KPI', details: createError?.message },
        { status: 500 }
      );
    }

    // Initialize progress cache for the new KPI
    await supabase
      .from('kpi_progress_cache')
      .upsert({
        kpi_id: newKpi.id,
        current_value: 0,
        target_value: body.numericTarget || null,
        progress_percentage: 0,
        child_count: 0,
        completed_child_count: 0,
        weighted_progress: 0,
        total_weight: 1,
        status: 'not_started',
        calculation_method: 'auto',
        last_calculated_at: new Date().toISOString(),
      }, { onConflict: 'kpi_id' });

    // If has parent, update parent's child_count
    if (body.parentKpiId) {
      // Increment parent's child_count in cache
      const { data: parentCache } = await supabase
        .from('kpi_progress_cache')
        .select('child_count')
        .eq('kpi_id', body.parentKpiId)
        .single();

      if (parentCache) {
        await supabase
          .from('kpi_progress_cache')
          .update({
            child_count: (parentCache.child_count || 0) + 1,
            last_calculated_at: new Date().toISOString(),
          })
          .eq('kpi_id', body.parentKpiId);
      }
    }

    return NextResponse.json({
      success: true,
      kpi: newKpi,
    }, { status: 201 });

  } catch (error) {
    console.error('Create KPI error:', error);
    return NextResponse.json(
      { error: 'Failed to create KPI', details: error instanceof Error ? error.message : 'Unknown error' },
      { status: 500 }
    );
  }
}
```
  </action>
  <verify>
1. File exists at src/app/api/vision-kpis/route.ts
2. POST handler validates visionId, title, level
3. Verifies vision ownership and parent KPI if provided
4. Creates KPI with parent_kpi_id support
5. Initializes progress cache
6. Run `npx tsc --noEmit`
  </verify>
  <done>
POST /api/vision-kpis endpoint created with:
- Required field validation (visionId, title, level)
- Vision ownership verification
- Parent KPI validation (same vision)
- KPI creation with parent_kpi_id support
- Progress cache initialization
- Parent child_count update
  </done>
</task>

<task type="auto">
  <name>Task 2: Add useCreateKpi mutation hook</name>
  <files>src/lib/hooks/use-kpi-mutations.ts, src/lib/hooks/index.ts</files>
  <action>
Add useCreateKpi mutation to the existing use-kpi-mutations.ts file.

**In use-kpi-mutations.ts, add:**

1. Add CreateKpiInput type:
```typescript
export interface CreateKpiInput {
  visionId: string;
  title: string;
  description?: string;
  level: 'quarterly' | 'monthly' | 'weekly' | 'daily';
  parentKpiId?: string | null;
  targetValue?: string;
  unit?: string;
  numericTarget?: number;
  weight?: number;
  quarter?: number;
  month?: number;
}
```

2. Add useCreateKpi hook:
```typescript
/**
 * Mutation hook for creating a new KPI manually.
 * Invalidates goal tree query on success to show new KPI.
 */
export function useCreateKpi(visionId: string | undefined) {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (input: CreateKpiInput) => {
      const response = await fetch('/api/vision-kpis', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(input),
      });

      if (!response.ok) {
        const data = await response.json().catch(() => ({}));
        throw new Error(data.error || 'Failed to create KPI');
      }

      return response.json();
    },
    onSuccess: () => {
      // Invalidate goal tree to show new KPI
      if (visionId) {
        queryClient.invalidateQueries({ queryKey: goalTreeKeys.tree(visionId) });
      }
    },
  });
}
```

**In index.ts, add export:**
```typescript
export { useCreateKpi, type CreateKpiInput } from './use-kpi-mutations';
```
  </action>
  <verify>
1. useCreateKpi function exists in use-kpi-mutations.ts
2. CreateKpiInput type is exported
3. Hook invalidates goal tree on success
4. Barrel export includes useCreateKpi
5. Run `npx tsc --noEmit`
  </verify>
  <done>
useCreateKpi mutation hook added:
- CreateKpiInput type defined
- Hook calls POST /api/vision-kpis
- Invalidates goal tree query on success
- Exported from hooks barrel
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. POST endpoint accepts visionId, title, level, parentKpiId
3. useCreateKpi hook exists and is exported
4. Hook invalidates goal tree on success
</verification>

<success_criteria>
1. POST /api/vision-kpis endpoint creates KPIs with optional parent linkage
2. Endpoint validates vision ownership and parent KPI
3. Endpoint initializes progress cache for new KPI
4. useCreateKpi mutation hook calls endpoint and invalidates cache
5. Types are properly exported
6. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-cascade-generation/05-02-SUMMARY.md`
</output>
