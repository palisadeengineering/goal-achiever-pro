---
phase: 06-tree-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/features/kpi/goal-tree-context.tsx
  - src/components/features/kpi/goal-tree-node.tsx
autonomous: true

must_haves:
  truths:
    - "Tree context provides expanded state management"
    - "Tree context provides selection and focus state"
    - "Tree node renders with Radix Collapsible"
    - "Expand/collapse works on click"
    - "Progress bar shows completion percentage"
  artifacts:
    - path: "src/components/features/kpi/goal-tree-context.tsx"
      provides: "GoalTreeProvider and useGoalTreeContext hook"
      exports: ["GoalTreeProvider", "useGoalTreeContext"]
    - path: "src/components/features/kpi/goal-tree-node.tsx"
      provides: "Recursive tree node with expand/collapse"
      exports: ["GoalTreeNode"]
  key_links:
    - from: "src/components/features/kpi/goal-tree-node.tsx"
      to: "src/components/features/kpi/goal-tree-context.tsx"
      via: "useGoalTreeContext hook"
      pattern: "useGoalTreeContext"
    - from: "src/components/features/kpi/goal-tree-node.tsx"
      to: "src/components/ui/collapsible.tsx"
      via: "Radix Collapsible components"
      pattern: "Collapsible|CollapsibleTrigger|CollapsibleContent"
---

<objective>
Create the tree context provider and recursive tree node component for the goal hierarchy UI.

Purpose: Provides state management for expand/collapse, selection, and focus across the tree, plus the core recursive node component using Radix Collapsible for accessible expand/collapse behavior.

Output: GoalTreeProvider context and GoalTreeNode component ready for composition in the main tree view.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-tree-ui/06-RESEARCH.md

# Existing components to build on
@src/components/features/kpi/kpi-tree-widget.tsx
@src/lib/progress/tree.ts
@src/components/ui/collapsible.tsx
@src/components/ui/progress.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GoalTreeContext provider</name>
  <files>src/components/features/kpi/goal-tree-context.tsx</files>
  <action>
Create the React Context for managing tree state with the following interface:

```typescript
interface GoalTreeContextValue {
  // Expanded state (which nodes are open)
  expandedIds: Set<string>;
  toggleExpanded: (id: string) => void;
  expandAll: () => void;
  collapseAll: () => void;
  setExpanded: (ids: string[]) => void;

  // Selection state (which node is selected)
  selectedId: string | null;
  setSelectedId: (id: string | null) => void;

  // Focus state (which node has keyboard focus - for roving tabindex)
  focusedId: string | null;
  setFocusedId: (id: string | null) => void;

  // Tree data (for breadcrumb path derivation)
  tree: KpiTreeNode[];
  visionTitle: string;
}
```

Implementation requirements:
- Use `useState` with `Set<string>` for expandedIds
- `toggleExpanded` should add/remove from the Set immutably
- `expandAll` should collect all node IDs recursively and set them
- `collapseAll` should set to empty Set
- `setExpanded` allows bulk setting (useful for default open state)
- Export `GoalTreeProvider` component that accepts `children`, `defaultExpanded?: string[]`, `tree: KpiTreeNode[]`, `visionTitle: string`
- Export `useGoalTreeContext` hook that throws if used outside provider
- Mark as 'use client' since it uses React hooks

Use the Pattern 3 example from 06-RESEARCH.md as reference but add the tree and visionTitle props for breadcrumb derivation.
  </action>
  <verify>
TypeScript compilation passes:
```bash
npx tsc --noEmit src/components/features/kpi/goal-tree-context.tsx
```
  </verify>
  <done>GoalTreeContext exports GoalTreeProvider and useGoalTreeContext with full state management for expanded, selected, and focused IDs.</done>
</task>

<task type="auto">
  <name>Task 2: Create GoalTreeNode recursive component</name>
  <files>src/components/features/kpi/goal-tree-node.tsx</files>
  <action>
Create a recursive tree node component following WAI-ARIA treeitem pattern.

Props interface:
```typescript
interface GoalTreeNodeProps {
  node: KpiTreeNode;
  level: number;        // For aria-level attribute
  posInSet: number;     // Position in sibling list (1-indexed for ARIA)
  setSize: number;      // Total siblings at this level
  onLogKpi?: (kpiId: string, isCompleted: boolean) => void;  // Optional callback for leaf completion
}
```

Implementation requirements:

1. **Mark as 'use client'** - uses hooks

2. **Get state from context:**
   ```typescript
   const { expandedIds, toggleExpanded, focusedId, setFocusedId, selectedId, setSelectedId } = useGoalTreeContext();
   ```

3. **Calculate derived state:**
   - `isExpanded = expandedIds.has(node.id)`
   - `isFocused = focusedId === node.id`
   - `isSelected = selectedId === node.id`
   - `hasChildren = node.children && node.children.length > 0`

4. **Use Radix Collapsible** from `@/components/ui/collapsible`:
   - Wrap entire node in `<Collapsible open={isExpanded} onOpenChange={() => toggleExpanded(node.id)}>`
   - Use `<CollapsibleTrigger asChild>` for the expand button
   - Use `<CollapsibleContent>` for children container

5. **ARIA attributes on the `<li>` element:**
   - `role="treeitem"`
   - `aria-level={level}`
   - `aria-setsize={setSize}`
   - `aria-posinset={posInSet}`
   - `aria-expanded={hasChildren ? isExpanded : undefined}`
   - `aria-selected={isSelected}`
   - `data-id={node.id}` (for keyboard navigation)
   - `tabIndex={isFocused ? 0 : -1}` (roving tabindex)

6. **Visual structure:**
   - Indent based on level: `paddingLeft: ${(level - 1) * 16 + 8}px`
   - Expand/collapse button with ChevronRight icon that rotates 90deg when expanded
   - Title text
   - Progress bar using shadcn Progress component showing `node.progress`
   - Percentage text (e.g., "75%")
   - For leaf nodes only: Checkbox to mark complete (uses onLogKpi callback)

7. **Recursive rendering for children:**
   ```tsx
   {hasChildren && isExpanded && (
     <CollapsibleContent>
       <ul role="group" className="border-l border-border ml-4">
         {node.children.map((child, index) => (
           <GoalTreeNode
             key={child.id}
             node={child}
             level={level + 1}
             posInSet={index + 1}
             setSize={node.children.length}
             onLogKpi={onLogKpi}
           />
         ))}
       </ul>
     </CollapsibleContent>
   )}
   ```

8. **Styling:**
   - Use `cn()` utility for conditional classes
   - Hover state on node row
   - Focus ring when isFocused
   - Highlighted background when isSelected
   - Use Tailwind transitions for expand/collapse icon rotation: `transition-transform duration-200`

Import from:
- `@/components/ui/collapsible` for Collapsible, CollapsibleTrigger, CollapsibleContent
- `@/components/ui/progress` for Progress
- `@/components/ui/checkbox` for Checkbox (leaf completion)
- `@/components/ui/button` for expand button
- `lucide-react` for ChevronRight icon
- `@/lib/utils` for cn()
- `@/lib/progress` for KpiTreeNode type
- `./goal-tree-context` for useGoalTreeContext
  </action>
  <verify>
TypeScript compilation passes:
```bash
npx tsc --noEmit src/components/features/kpi/goal-tree-node.tsx
```
  </verify>
  <done>GoalTreeNode component renders recursively with Radix Collapsible, progress bars, proper ARIA attributes, and roving tabindex support.</done>
</task>

</tasks>

<verification>
1. Both files compile without TypeScript errors
2. GoalTreeContext exports are available:
   ```bash
   grep -E "export.*(GoalTreeProvider|useGoalTreeContext)" src/components/features/kpi/goal-tree-context.tsx
   ```
3. GoalTreeNode uses context:
   ```bash
   grep "useGoalTreeContext" src/components/features/kpi/goal-tree-node.tsx
   ```
4. GoalTreeNode uses Collapsible:
   ```bash
   grep -E "Collapsible|CollapsibleTrigger|CollapsibleContent" src/components/features/kpi/goal-tree-node.tsx
   ```
</verification>

<success_criteria>
- GoalTreeContext manages expanded, selected, and focused state
- GoalTreeNode renders recursively with proper ARIA attributes
- Expand/collapse uses Radix Collapsible for accessibility
- Progress bar shows node.progress value
- Both components compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-tree-ui/06-01-SUMMARY.md`
</output>
