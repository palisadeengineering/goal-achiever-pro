# Plan 09-01: Gamification Database Schema

## Objective

Create the database schema for gamification features: achievements table with predefined achievement types, user_achievements junction table for tracking unlocks, and user_gamification table for XP/level tracking.

## Execution Context

**Phase**: 9 - Gamification Foundation
**Depends on**: v1.0 complete (existing kpiStreaks table as pattern reference)
**Scope**: ~150 lines schema code, 3 new tables

**Reference files**:
- `src/lib/db/schema.ts` - existing schema patterns (kpiStreaks at line 1083)
- `.planning/codebase/CONVENTIONS.md` - naming conventions

## Context

**Existing patterns to follow**:
- UUID primary keys with `.defaultRandom()`
- `user_id` foreign key to profiles with `onDelete: 'cascade'`
- `created_at` / `updated_at` timestamps
- Drizzle pgTable with pgEnum for enums
- Snake_case for database columns, camelCase for TypeScript

**Achievement types to support**:
- First KPI completed
- First vision created
- Streak milestones (7, 30, 100 days)
- Completion milestones (10, 50, 100, 500 KPIs)
- Level-up achievements

## Tasks

### Task 1: Create achievement category enum
**File**: `src/lib/db/schema.ts`
**Action**: Add enum after existing enums (around line 50)

```typescript
export const achievementCategoryEnum = pgEnum('achievement_category', [
  'milestone',    // Completion count milestones
  'streak',       // Streak-based achievements
  'exploration',  // Using features for first time
  'mastery',      // Advanced usage patterns
]);
```

### Task 2: Create achievements table (predefined achievement definitions)
**File**: `src/lib/db/schema.ts`
**Action**: Add after kpiStreaks table (around line 1095)

```typescript
export const achievements = pgTable('achievements', {
  id: uuid('id').primaryKey().defaultRandom(),
  key: varchar('key', { length: 50 }).notNull().unique(), // e.g., 'first_kpi', 'streak_7'
  name: varchar('name', { length: 100 }).notNull(),
  description: text('description').notNull(),
  category: achievementCategoryEnum('category').notNull(),
  iconName: varchar('icon_name', { length: 50 }), // Lucide icon name
  xpReward: integer('xp_reward').default(0),
  requiredValue: integer('required_value'), // e.g., 7 for 7-day streak
  isSecret: boolean('is_secret').default(false), // Hidden until unlocked
  createdAt: timestamp('created_at').defaultNow(),
});
```

### Task 3: Create user_achievements junction table
**File**: `src/lib/db/schema.ts`
**Action**: Add after achievements table

```typescript
export const userAchievements = pgTable('user_achievements', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().references(() => profiles.id, { onDelete: 'cascade' }),
  achievementId: uuid('achievement_id').notNull().references(() => achievements.id, { onDelete: 'cascade' }),
  unlockedAt: timestamp('unlocked_at').defaultNow(),
  progressValue: integer('progress_value'), // Current progress toward achievement
}, (table) => ({
  uniqueUserAchievement: unique().on(table.userId, table.achievementId),
}));
```

### Task 4: Create user_gamification table (XP/level tracking)
**File**: `src/lib/db/schema.ts`
**Action**: Add after user_achievements table

```typescript
export const userGamification = pgTable('user_gamification', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().references(() => profiles.id, { onDelete: 'cascade' }).unique(),
  totalXp: integer('total_xp').default(0),
  currentLevel: integer('current_level').default(1),
  kpisCompleted: integer('kpis_completed').default(0),
  visionsCreated: integer('visions_created').default(0),
  longestStreak: integer('longest_streak').default(0),
  currentStreak: integer('current_streak').default(0),
  lastActivityDate: date('last_activity_date'),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
});
```

### Task 5: Add TypeScript types
**File**: `src/types/gamification.ts` (new file)
**Action**: Create type definitions

```typescript
export interface Achievement {
  id: string;
  key: string;
  name: string;
  description: string;
  category: 'milestone' | 'streak' | 'exploration' | 'mastery';
  iconName: string | null;
  xpReward: number;
  requiredValue: number | null;
  isSecret: boolean;
  createdAt: Date;
}

export interface UserAchievement {
  id: string;
  oderId: string;
  achievementId: string;
  unlockedAt: Date;
  progressValue: number | null;
  achievement?: Achievement; // Joined data
}

export interface UserGamification {
  id: string;
  userId: string;
  totalXp: number;
  currentLevel: number;
  kpisCompleted: number;
  visionsCreated: number;
  longestStreak: number;
  currentStreak: number;
  lastActivityDate: string | null;
  createdAt: Date;
  updatedAt: Date;
}

// Level thresholds (XP required for each level)
export const LEVEL_THRESHOLDS = [
  0,      // Level 1
  100,    // Level 2
  300,    // Level 3
  600,    // Level 4
  1000,   // Level 5
  1500,   // Level 6
  2100,   // Level 7
  2800,   // Level 8
  3600,   // Level 9
  4500,   // Level 10
  5500,   // Level 11+
] as const;

// XP rewards for actions
export const XP_REWARDS = {
  KPI_COMPLETED: 10,
  VISION_CREATED: 50,
  STREAK_DAY: 5,
  ACHIEVEMENT_BONUS: 25,
} as const;
```

### Task 6: Add relations to schema
**File**: `src/lib/db/schema.ts`
**Action**: Add Drizzle relations after table definitions

```typescript
export const achievementsRelations = relations(achievements, ({ many }) => ({
  userAchievements: many(userAchievements),
}));

export const userAchievementsRelations = relations(userAchievements, ({ one }) => ({
  user: one(profiles, {
    fields: [userAchievements.userId],
    references: [profiles.id],
  }),
  achievement: one(achievements, {
    fields: [userAchievements.achievementId],
    references: [achievements.id],
  }),
}));

export const userGamificationRelations = relations(userGamification, ({ one }) => ({
  user: one(profiles, {
    fields: [userGamification.userId],
    references: [profiles.id],
  }),
}));
```

### Task 7: Push schema to database
**Command**: `npx drizzle-kit push`
**Verify**: Tables created in Supabase

### Task 8: Seed initial achievements
**File**: `src/lib/db/seed-achievements.ts` (new file)
**Action**: Create seed script for predefined achievements

```typescript
import { adminClient } from '@/lib/supabase/admin';

export const PREDEFINED_ACHIEVEMENTS = [
  // Exploration
  { key: 'first_vision', name: 'Visionary', description: 'Created your first vision', category: 'exploration', iconName: 'Eye', xpReward: 50, requiredValue: 1 },
  { key: 'first_kpi', name: 'First Step', description: 'Completed your first KPI', category: 'exploration', iconName: 'CheckCircle', xpReward: 25, requiredValue: 1 },

  // Milestones
  { key: 'kpi_10', name: 'Getting Started', description: 'Completed 10 KPIs', category: 'milestone', iconName: 'Trophy', xpReward: 50, requiredValue: 10 },
  { key: 'kpi_50', name: 'Momentum Builder', description: 'Completed 50 KPIs', category: 'milestone', iconName: 'Zap', xpReward: 100, requiredValue: 50 },
  { key: 'kpi_100', name: 'Century Club', description: 'Completed 100 KPIs', category: 'milestone', iconName: 'Award', xpReward: 200, requiredValue: 100 },
  { key: 'kpi_500', name: 'Goal Machine', description: 'Completed 500 KPIs', category: 'milestone', iconName: 'Rocket', xpReward: 500, requiredValue: 500 },

  // Streaks
  { key: 'streak_7', name: 'Week Warrior', description: 'Maintained a 7-day streak', category: 'streak', iconName: 'Flame', xpReward: 75, requiredValue: 7 },
  { key: 'streak_30', name: 'Monthly Master', description: 'Maintained a 30-day streak', category: 'streak', iconName: 'Calendar', xpReward: 200, requiredValue: 30 },
  { key: 'streak_100', name: 'Unstoppable', description: 'Maintained a 100-day streak', category: 'streak', iconName: 'Crown', xpReward: 500, requiredValue: 100 },

  // Mastery
  { key: 'level_5', name: 'Rising Star', description: 'Reached level 5', category: 'mastery', iconName: 'Star', xpReward: 100, requiredValue: 5 },
  { key: 'level_10', name: 'Achievement Hunter', description: 'Reached level 10', category: 'mastery', iconName: 'Medal', xpReward: 250, requiredValue: 10 },
];

export async function seedAchievements() {
  const { data: existing } = await adminClient
    .from('achievements')
    .select('key');

  const existingKeys = new Set(existing?.map(a => a.key) || []);
  const toInsert = PREDEFINED_ACHIEVEMENTS.filter(a => !existingKeys.has(a.key));

  if (toInsert.length > 0) {
    const { error } = await adminClient
      .from('achievements')
      .insert(toInsert);

    if (error) throw error;
    console.log(`Seeded ${toInsert.length} achievements`);
  }

  return toInsert.length;
}
```

## Verification

1. **Schema compiles**: `npm run build` passes
2. **Tables exist**: Check Supabase dashboard for new tables
3. **Types correct**: TypeScript types match schema
4. **Seed works**: Run seed script, verify achievements in database

## Success Criteria

- [ ] `achievements` table created with enum category
- [ ] `user_achievements` junction table with unique constraint
- [ ] `user_gamification` table with XP/level fields
- [ ] TypeScript types exported from `src/types/gamification.ts`
- [ ] Drizzle relations defined
- [ ] 12 predefined achievements seeded
- [ ] All builds pass

## Output

After completing this plan:
- 3 new database tables ready for gamification features
- TypeScript types for gamification data
- Predefined achievements seeded
- Ready for Plan 09-02 (service and API integration)
