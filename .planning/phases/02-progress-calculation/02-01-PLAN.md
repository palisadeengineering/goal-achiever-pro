---
phase: 02-progress-calculation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/progress/types.ts
  - src/lib/progress/calculator.ts
  - src/lib/progress/rollup.ts
  - src/lib/db/schema.ts
  - drizzle/migrations/0003_add_kpi_weight.sql
autonomous: true

must_haves:
  truths:
    - "Weighted progress calculation correctly weights higher-weight KPIs more"
    - "Progress calculator handles edge cases (zero children, zero weights, manual override)"
    - "Schema includes weight column on vision_kpis table"
  artifacts:
    - path: "src/lib/progress/types.ts"
      provides: "ProgressFormula, WeightedKPI, ProgressResult types"
      exports: ["ProgressFormula", "WeightedKPI", "ProgressResult", "CalculationMethod"]
    - path: "src/lib/progress/calculator.ts"
      provides: "Core weighted progress calculation logic"
      exports: ["calculateWeightedProgress", "buildProgressFormula"]
    - path: "src/lib/progress/rollup.ts"
      provides: "Hierarchical ancestor traversal and rollup functions"
      exports: ["getKpiAncestors", "rollupProgressToAncestors"]
    - path: "src/lib/db/schema.ts"
      provides: "weight column on visionKpis table"
      contains: "weight: decimal"
    - path: "drizzle/migrations/0003_add_kpi_weight.sql"
      provides: "Migration to add weight column"
      contains: "ADD COLUMN"
  key_links:
    - from: "src/lib/progress/calculator.ts"
      to: "src/lib/progress/types.ts"
      via: "import types"
      pattern: "import.*from.*types"
    - from: "src/lib/progress/rollup.ts"
      to: "src/lib/progress/calculator.ts"
      via: "import calculator"
      pattern: "import.*from.*calculator"
---

<objective>
Build the core progress calculation library with weighted averaging, formula transparency, and hierarchical rollup support.

Purpose: This is the foundation for all progress calculations - enabling PROG-01 (parent updates), PROG-02 (full chain rollup), PROG-03 (weights), and PROG-05 (formula transparency).

Output: Type-safe progress calculation library in `src/lib/progress/` with schema migration for weight column.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-progress-calculation/02-RESEARCH.md
@.planning/phases/01-schema-foundation/01-01-SUMMARY.md
@.planning/phases/01-schema-foundation/01-02-SUMMARY.md
@src/lib/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create progress types</name>
  <files>src/lib/progress/types.ts</files>
  <action>
Create TypeScript types for the progress calculation system:

```typescript
// CalculationMethod - how progress was calculated
export type CalculationMethod = 'auto' | 'manual_override';

// WeightedKPI - input for progress calculations
export interface WeightedKPI {
  id: string;
  title: string;
  progress: number;  // 0-100
  weight: number;    // Default 1, user-configurable
}

// ProgressComponent - individual contribution to parent progress
export interface ProgressComponent {
  kpiId: string;
  kpiTitle: string;
  progress: number;
  weight: number;
  contribution: number;  // (weight * progress) / totalWeight
}

// ProgressFormula - transparent breakdown for UI (PROG-05)
export interface ProgressFormula {
  resultPercentage: number;
  method: CalculationMethod;
  components: ProgressComponent[];
  formula: string;  // Human-readable: "((85% * 2) + (60% * 1)) / 3 = 76.67%"
  overrideReason?: string;
  overrideBy?: string;
  overrideAt?: Date;
}

// ProgressResult - return type from calculation functions
export interface ProgressResult {
  kpiId: string;
  progressPercentage: number;
  formula: ProgressFormula;
  childCount: number;
  completedChildCount: number;
  weightedProgress: number;
  totalWeight: number;
  status: 'not_started' | 'in_progress' | 'at_risk' | 'on_track' | 'completed';
}

// KpiAncestor - result from recursive ancestor query
export interface KpiAncestor {
  id: string;
  parentKpiId: string | null;
  level: string;
  title: string;
  depth: number;
}
```

Export all types.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/lib/progress/types.ts`</verify>
  <done>Types file exists with all exported interfaces matching the spec</done>
</task>

<task type="auto">
  <name>Task 2: Create progress calculator with weighted averaging</name>
  <files>src/lib/progress/calculator.ts</files>
  <action>
First, install the decimal.js package:

```bash
npm install decimal.js
```

Then create the core progress calculation logic:

```typescript
import Decimal from 'decimal.js';
import type { WeightedKPI, ProgressFormula, ProgressComponent, CalculationMethod } from './types';

// Configure decimal.js for percentage precision
Decimal.set({ precision: 10, rounding: Decimal.ROUND_HALF_UP });

/**
 * Calculate weighted progress from child KPIs
 * Returns progress percentage 0-100 rounded to 2 decimal places
 */
export function calculateWeightedProgress(children: WeightedKPI[]): number {
  if (children.length === 0) return 0;

  const totalWeight = children.reduce(
    (sum, c) => sum.plus(new Decimal(c.weight || 1)),
    new Decimal(0)
  );

  if (totalWeight.isZero()) return 0;

  const weightedSum = children.reduce(
    (sum, c) => sum.plus(
      new Decimal(c.progress || 0).times(new Decimal(c.weight || 1))
    ),
    new Decimal(0)
  );

  return weightedSum.dividedBy(totalWeight).toDecimalPlaces(2).toNumber();
}

/**
 * Build transparent formula breakdown for UI (PROG-05)
 */
export function buildProgressFormula(
  children: WeightedKPI[],
  options?: {
    manualOverride?: number;
    overrideReason?: string;
    overrideBy?: string;
  }
): ProgressFormula {
  if (children.length === 0) {
    return {
      resultPercentage: options?.manualOverride ?? 0,
      method: options?.manualOverride !== undefined ? 'manual_override' : 'auto',
      components: [],
      formula: 'No child items',
      overrideReason: options?.overrideReason,
    };
  }

  const totalWeight = new Decimal(
    children.reduce((sum, c) => sum + (c.weight || 1), 0)
  );

  const components: ProgressComponent[] = children.map(c => {
    const weight = new Decimal(c.weight || 1);
    const progress = new Decimal(c.progress || 0);
    const contribution = totalWeight.isZero()
      ? 0
      : progress.times(weight).dividedBy(totalWeight).toDecimalPlaces(2).toNumber();

    return {
      kpiId: c.id,
      kpiTitle: c.title,
      progress: c.progress || 0,
      weight: c.weight || 1,
      contribution,
    };
  });

  const calculatedProgress = calculateWeightedProgress(children);

  // Build human-readable formula
  const parts = children.map(c => `(${c.progress}% x ${c.weight})`);
  const formula = `(${parts.join(' + ')}) / ${totalWeight.toNumber()} = ${calculatedProgress.toFixed(2)}%`;

  const isManualOverride = options?.manualOverride !== undefined;

  return {
    resultPercentage: isManualOverride ? options.manualOverride : calculatedProgress,
    method: isManualOverride ? 'manual_override' : 'auto',
    components,
    formula: isManualOverride
      ? `Manual override: ${options.manualOverride}% (auto-calc would be ${calculatedProgress.toFixed(2)}%)`
      : formula,
    overrideReason: options?.overrideReason,
    overrideBy: options?.overrideBy,
    overrideAt: isManualOverride ? new Date() : undefined,
  };
}

/**
 * Derive status from progress percentage
 */
export function deriveStatus(
  progressPercentage: number,
  options?: { isOverdue?: boolean }
): 'not_started' | 'in_progress' | 'at_risk' | 'on_track' | 'completed' {
  if (progressPercentage >= 100) return 'completed';
  if (progressPercentage === 0) return 'not_started';
  if (options?.isOverdue && progressPercentage < 80) return 'at_risk';
  if (progressPercentage >= 70) return 'on_track';
  if (progressPercentage >= 30) return 'in_progress';
  return 'at_risk';
}

/**
 * Count completed children (progress >= 100)
 */
export function countCompletedChildren(children: WeightedKPI[]): number {
  return children.filter(c => c.progress >= 100).length;
}
```
  </action>
  <verify>
1. Run `npm install decimal.js` if not already installed
2. Verify decimal.js in package.json dependencies: `grep "decimal.js" package.json`
3. Run `npm run build` - no TypeScript errors
  </verify>
  <done>Calculator module exports calculateWeightedProgress, buildProgressFormula, deriveStatus, countCompletedChildren and decimal.js is installed</done>
</task>

<task type="auto">
  <name>Task 3: Create rollup module with recursive ancestor traversal</name>
  <files>src/lib/progress/rollup.ts</files>
  <action>
Create the hierarchical rollup logic with SQL for ancestor traversal:

```typescript
import { sql } from 'drizzle-orm';
import type { KpiAncestor, ProgressResult, WeightedKPI } from './types';
import { calculateWeightedProgress, buildProgressFormula, deriveStatus, countCompletedChildren } from './calculator';

/**
 * SQL query to get all ancestors of a KPI using recursive CTE
 * Returns ancestors from child to root (depth ascending)
 */
export function getAncestorsCteQuery(kpiId: string) {
  return sql`
    WITH RECURSIVE kpi_ancestors AS (
      -- Anchor: start with the changed KPI
      SELECT id, parent_kpi_id, level, title, 1 as depth
      FROM vision_kpis
      WHERE id = ${kpiId}

      UNION ALL

      -- Recursive: traverse up the tree
      SELECT p.id, p.parent_kpi_id, p.level, p.title, ka.depth + 1
      FROM vision_kpis p
      INNER JOIN kpi_ancestors ka ON p.id = ka.parent_kpi_id
      WHERE p.is_active = true
    )
    SELECT * FROM kpi_ancestors ORDER BY depth ASC
  `;
}

/**
 * SQL query to get direct children of a KPI with their progress from cache
 */
export function getChildrenWithProgressQuery(parentKpiId: string) {
  return sql`
    SELECT
      vk.id,
      vk.title,
      vk.weight,
      COALESCE(pc.progress_percentage, 0) as progress
    FROM vision_kpis vk
    LEFT JOIN kpi_progress_cache pc ON pc.kpi_id = vk.id
    WHERE vk.parent_kpi_id = ${parentKpiId}
      AND vk.is_active = true
    ORDER BY vk.sort_order ASC
  `;
}

/**
 * Calculate progress for a single KPI based on its children
 * Returns ProgressResult with formula breakdown
 */
export function calculateKpiProgress(
  kpiId: string,
  children: WeightedKPI[],
  options?: {
    manualOverride?: number;
    overrideReason?: string;
    overrideBy?: string;
  }
): ProgressResult {
  const formula = buildProgressFormula(children, options);
  const progressPercentage = formula.resultPercentage;

  return {
    kpiId,
    progressPercentage,
    formula,
    childCount: children.length,
    completedChildCount: countCompletedChildren(children),
    weightedProgress: calculateWeightedProgress(children),
    totalWeight: children.reduce((sum, c) => sum + (c.weight || 1), 0),
    status: deriveStatus(progressPercentage),
  };
}

/**
 * Build update data for kpi_progress_cache table
 */
export function buildCacheUpdateData(result: ProgressResult) {
  return {
    progress_percentage: result.progressPercentage.toString(),
    child_count: result.childCount,
    completed_child_count: result.completedChildCount,
    weighted_progress: result.weightedProgress.toString(),
    total_weight: result.totalWeight.toString(),
    status: result.status,
    calculation_method: result.formula.method,
    manual_override_reason: result.formula.overrideReason || null,
    last_calculated_at: new Date().toISOString(),
    updated_at: new Date().toISOString(),
  };
}

// Re-export types for convenience
export type { KpiAncestor, ProgressResult, WeightedKPI };
```

This module provides the SQL queries and calculation logic needed for the API endpoints in Plan 02.
  </action>
  <verify>
1. Run `npx tsc --noEmit src/lib/progress/rollup.ts` - no errors
2. Check imports resolve correctly
  </verify>
  <done>Rollup module exports CTE query builders and progress calculation functions</done>
</task>

<task type="auto">
  <name>Task 4: Add weight column to vision_kpis schema and create migration</name>
  <files>src/lib/db/schema.ts, drizzle/migrations/0003_add_kpi_weight.sql</files>
  <action>
1. Update `src/lib/db/schema.ts` - add weight column to visionKpis table:

Find the visionKpis table definition (around line 930) and add after the `parentKpiId` line:
```typescript
  // Weight for weighted progress calculation (PROG-03)
  weight: decimal('weight', { precision: 5, scale: 2 }).default('1'),
```

2. Create migration file `drizzle/migrations/0003_add_kpi_weight.sql`:
```sql
-- Add weight column to vision_kpis for weighted progress calculation
-- Default weight of 1 means equal weighting

ALTER TABLE "vision_kpis"
ADD COLUMN IF NOT EXISTS "weight" DECIMAL(5, 2) DEFAULT 1;

-- Add comment explaining the column
COMMENT ON COLUMN "vision_kpis"."weight" IS 'Weight for weighted progress calculation. Higher weights contribute more to parent progress. Default 1 for equal weighting.';
```

This enables requirement PROG-03 (user can assign weights to KPIs).
  </action>
  <verify>
1. Run `npm run build` - no TypeScript errors
2. Verify migration file exists and contains ADD COLUMN statement
  </verify>
  <done>Schema has weight column, migration file ready to apply</done>
</task>

</tasks>

<verification>
1. All files exist:
   - `src/lib/progress/types.ts`
   - `src/lib/progress/calculator.ts`
   - `src/lib/progress/rollup.ts`
   - `drizzle/migrations/0003_add_kpi_weight.sql`
2. TypeScript compiles: `npm run build` passes
3. decimal.js is in package.json dependencies
4. Weight column exists in schema.ts visionKpis table
5. Exports are correct (import each module and check exports)
</verification>

<success_criteria>
- Progress library provides type-safe weighted calculation
- Formula breakdown includes human-readable explanation
- Schema migration adds weight column with default 1
- All modules compile without errors
- decimal.js package is installed
</success_criteria>

<output>
After completion, create `.planning/phases/02-progress-calculation/02-01-SUMMARY.md`
</output>
