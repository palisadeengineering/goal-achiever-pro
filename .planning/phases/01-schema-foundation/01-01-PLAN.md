---
phase: 01-schema-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/schema.ts
  - drizzle/migrations/[timestamp]_add_parent_kpi_fk.sql
autonomous: true

must_haves:
  truths:
    - "KPIs can reference parent KPIs via parent_kpi_id with database-enforced integrity"
    - "Queries filtering by parent_kpi_id execute with index scan, not sequential"
    - "Self-referential relationship allows 5 levels of nesting without circular reference"
  artifacts:
    - path: "drizzle/migrations/*_add_parent_kpi_fk.sql"
      provides: "Migration adding FK constraint and index"
      contains: "FOREIGN KEY"
    - path: "src/lib/db/schema.ts"
      provides: "Updated schema with explicit FK reference"
      contains: "references.*visionKpis"
  key_links:
    - from: "vision_kpis.parent_kpi_id"
      to: "vision_kpis.id"
      via: "FOREIGN KEY constraint"
      pattern: "REFERENCES.*vision_kpis.*id"
---

<objective>
Add proper foreign key constraint and index to the existing parent_kpi_id column in vision_kpis table.

Purpose: The parent_kpi_id column exists but lacks database-level referential integrity. This creates risk of orphaned KPIs and prevents the database from enforcing valid hierarchy relationships. Adding the FK and index is foundational for all cascade features.

Output: Migration file adding FK constraint (using NOT VALID for safety) and btree index on parent_kpi_id column.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md
@src/lib/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update schema.ts with FK reference and generate migration</name>
  <files>src/lib/db/schema.ts</files>
  <action>
Update the visionKpis table definition in schema.ts to add an explicit foreign key reference to the parentKpiId column. The column already exists at line ~943 as:

```typescript
parentKpiId: uuid('parent_kpi_id'),
```

Change it to include the self-reference:

```typescript
parentKpiId: uuid('parent_kpi_id').references(() => visionKpis.id, { onDelete: 'set null' }),
```

Also add an index to the table definition in the table options callback (after line ~963):

```typescript
}, (table) => ({
  userVisionIdx: index('vision_kpis_user_vision_idx').on(table.userId, table.visionId),
  levelIdx: index('vision_kpis_level_idx').on(table.visionId, table.level),
  parentKpiIdx: index('vision_kpis_parent_kpi_idx').on(table.parentKpiId),
}));
```

After updating schema.ts, generate the migration using:

```bash
npx drizzle-kit generate
```

This will create a migration file in drizzle/migrations/ directory.

WHY onDelete: 'set null': If a parent KPI is deleted, child KPIs should become root-level items rather than being cascade-deleted. This preserves user work while breaking the hierarchy link.

WHY NOT CASCADE: Deleting a quarterly KPI should not delete all monthly/weekly/daily KPIs underneath - that would be catastrophic data loss.
  </action>
  <verify>
1. Run `npx drizzle-kit generate` and confirm migration file is created
2. Check migration file contains: ALTER TABLE with FOREIGN KEY constraint, CREATE INDEX for parent_kpi_id
3. Verify schema.ts has the .references() call on parentKpiId
  </verify>
  <done>
Migration file exists in drizzle/migrations/ with FK constraint (referencing vision_kpis.id) and index creation statements. Schema.ts updated with explicit FK reference.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply migration and validate constraint</name>
  <files>drizzle/migrations/[timestamp]_add_parent_kpi_fk.sql</files>
  <action>
Apply the generated migration to the database:

```bash
npx drizzle-kit push
```

If the migration fails due to existing invalid data (orphaned parent_kpi_id references), the FK constraint needs the NOT VALID approach. Edit the generated migration file to use:

```sql
-- Add FK constraint without validating existing data (non-blocking)
ALTER TABLE vision_kpis
ADD CONSTRAINT vision_kpis_parent_kpi_id_fkey
FOREIGN KEY (parent_kpi_id)
REFERENCES vision_kpis(id)
ON DELETE SET NULL
NOT VALID;

-- Validate constraint in separate transaction (can be done later if data cleanup needed)
ALTER TABLE vision_kpis VALIDATE CONSTRAINT vision_kpis_parent_kpi_id_fkey;
```

If validation fails, first run a cleanup query to identify orphans:

```sql
SELECT id, parent_kpi_id FROM vision_kpis
WHERE parent_kpi_id IS NOT NULL
AND parent_kpi_id NOT IN (SELECT id FROM vision_kpis);
```

Set any orphaned parent_kpi_id values to NULL before validating.

WHY NOT VALID first: On large tables, adding a validated FK locks the table for the entire check. NOT VALID adds the constraint immediately (for new writes) then VALIDATE checks existing data in a separate, interruptible operation.
  </action>
  <verify>
1. Run `npx drizzle-kit push` successfully
2. Verify FK exists: Connect to database and run `\d vision_kpis` or query information_schema.table_constraints
3. Verify index exists: Query pg_indexes for vision_kpis_parent_kpi_idx
4. Test FK enforcement: Attempt to insert a KPI with invalid parent_kpi_id - should fail with FK violation
  </verify>
  <done>
Database has vision_kpis_parent_kpi_id_fkey constraint enforced. Index vision_kpis_parent_kpi_idx exists. Attempting to insert invalid parent_kpi_id returns foreign key violation error.
  </done>
</task>

</tasks>

<verification>
Overall phase verification for Plan 01:

1. Schema integrity check:
   ```sql
   SELECT conname, contype FROM pg_constraint
   WHERE conrelid = 'vision_kpis'::regclass AND conname LIKE '%parent%';
   ```
   Expected: vision_kpis_parent_kpi_id_fkey with contype='f'

2. Index existence check:
   ```sql
   SELECT indexname FROM pg_indexes
   WHERE tablename = 'vision_kpis' AND indexname LIKE '%parent%';
   ```
   Expected: vision_kpis_parent_kpi_idx

3. FK enforcement test:
   ```sql
   INSERT INTO vision_kpis (user_id, vision_id, level, title, parent_kpi_id)
   VALUES ('some-user-id', 'some-vision-id', 'daily', 'Test', 'non-existent-uuid');
   ```
   Expected: ERROR: insert or update on table "vision_kpis" violates foreign key constraint
</verification>

<success_criteria>
- [x] Migration file generated with FK constraint and index
- [x] Migration applied successfully to database
- [x] FK constraint enforced on new inserts
- [x] Index visible in pg_indexes
- [x] Drizzle schema reflects the FK reference
</success_criteria>

<output>
After completion, create `.planning/phases/01-schema-foundation/01-01-SUMMARY.md`
</output>
