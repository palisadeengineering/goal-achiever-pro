---
phase: 02-progress-calculation
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/app/api/vision-kpis/[id]/log/route.ts
  - src/lib/progress/index.ts
autonomous: true

must_haves:
  truths:
    - "Logging a KPI completion updates all ancestor progress percentages"
    - "Progress cache updates within 100ms of KPI log write"
    - "Progress library has clean barrel export"
  artifacts:
    - path: "src/app/api/vision-kpis/[id]/log/route.ts"
      provides: "Updated KPI logging with progress rollup"
      contains: "rollupProgressToAncestors"
    - path: "src/lib/progress/index.ts"
      provides: "Barrel export for progress library"
      exports: ["calculateWeightedProgress", "buildProgressFormula", "rollupProgressToAncestors"]
  key_links:
    - from: "src/app/api/vision-kpis/[id]/log/route.ts"
      to: "src/lib/progress/ancestor-rollup.ts"
      via: "import rollup function"
      pattern: "import.*rollupProgressToAncestors.*from"
---

<objective>
Integrate progress rollup into the existing KPI log endpoint and create barrel export for the progress library.

Purpose: This completes PROG-01 (auto-update parent), PROG-02 (full chain rollup), and PROG-06 (<100ms cache update).

Output: KPI log endpoint triggers ancestor progress updates on every log write.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-progress-calculation/02-RESEARCH.md
@.planning/phases/02-progress-calculation/02-01-SUMMARY.md
@.planning/phases/02-progress-calculation/02-02-SUMMARY.md
@src/app/api/vision-kpis/[id]/log/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create barrel export for progress library</name>
  <files>src/lib/progress/index.ts</files>
  <action>
Create a clean barrel export for the progress library:

```typescript
/**
 * Progress Calculation Library
 *
 * Provides weighted progress calculation, formula transparency,
 * and hierarchical rollup for the KPI cascade system.
 *
 * Usage:
 *   import { calculateWeightedProgress, buildProgressFormula } from '@/lib/progress';
 */

// Types
export type {
  CalculationMethod,
  WeightedKPI,
  ProgressComponent,
  ProgressFormula,
  ProgressResult,
  KpiAncestor,
} from './types';

// Calculator functions
export {
  calculateWeightedProgress,
  buildProgressFormula,
  deriveStatus,
  countCompletedChildren,
} from './calculator';

// Rollup functions
export {
  getAncestorsCteQuery,
  getChildrenWithProgressQuery,
  calculateKpiProgress,
  buildCacheUpdateData,
} from './rollup';

// Ancestor rollup utilities
export {
  rollupProgressToAncestors,
  recalculateParentChain,
} from './ancestor-rollup';
```

This allows clean imports like:
```typescript
import { calculateWeightedProgress, type ProgressFormula } from '@/lib/progress';
```
  </action>
  <verify>
1. File exists at `src/lib/progress/index.ts`
2. `npm run build` passes
3. Can import from `@/lib/progress` in another file
  </verify>
  <done>Progress library has clean barrel export</done>
</task>

<task type="auto">
  <name>Task 2: Integrate progress rollup into KPI log endpoint</name>
  <files>src/app/api/vision-kpis/[id]/log/route.ts</files>
  <action>
Update the existing KPI log endpoint to trigger progress rollup on every log write.

**Current file structure (verified):**
- Lines 1-11: Imports and DEMO_USER_ID constant
- Lines 13-67: GET handler
- Lines 69-147: POST handler (this is what we modify)
- Lines 149-189: DELETE handler
- Lines 191-243: updateStreak helper function
- Lines 245-321: recalculateStreak helper function

**Step 1: Add import at line 3** (after existing imports, before DEMO_USER_ID):

Add after line 2 (`import { createClient } from '@/lib/supabase/server';`):
```typescript
import { rollupProgressToAncestors } from '@/lib/progress';
```

**Step 2: Modify POST handler return** (around line 140-142):

Find the existing lines at the end of POST handler:
```typescript
    // Update streak data
    await updateStreak(supabase, id, logDate, isCompleted);

    return NextResponse.json({ log });
```

Replace with:
```typescript
    // Update streak data
    await updateStreak(supabase, id, logDate, isCompleted);

    // Roll up progress to all ancestors (PROG-01, PROG-02)
    const rollupResult = await rollupProgressToAncestors(supabase, id);

    return NextResponse.json({
      log,
      rollup: {
        updatedKpis: rollupResult.updatedKpis,
        duration: rollupResult.duration,
      },
    });
```

This ensures every KPI log triggers ancestor progress recalculation.
  </action>
  <verify>
1. `npm run build` passes
2. POST handler imports rollupProgressToAncestors from @/lib/progress
3. POST handler calls rollupProgressToAncestors after updateStreak
4. Response includes rollup metadata with updatedKpis and duration
  </verify>
  <done>KPI log writes trigger automatic ancestor progress updates</done>
</task>

</tasks>

<verification>
1. All files exist:
   - `src/lib/progress/index.ts`
   - `src/app/api/vision-kpis/[id]/log/route.ts` (updated)
2. `npm run build` passes without errors
3. Log endpoint imports from progress barrel export
4. Log endpoint response includes rollup timing info
</verification>

<success_criteria>
- Logging a KPI completion triggers ancestor progress recalculation
- Response includes timing info to verify <100ms target (PROG-06)
- Progress library has clean single import path
</success_criteria>

<output>
After completion, create `.planning/phases/02-progress-calculation/02-03-SUMMARY.md`
</output>
