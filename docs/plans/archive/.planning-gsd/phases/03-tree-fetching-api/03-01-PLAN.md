---
phase: 03-tree-fetching-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/goal-tree/[visionId]/route.ts
  - src/lib/progress/tree.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/goal-tree/{visionId} returns complete nested hierarchy with one API call"
    - "Response includes all KPI levels from vision down to daily"
    - "Each node includes progress percentage from cache"
    - "Response structure enables frontend tree rendering without additional processing"
  artifacts:
    - path: "src/app/api/goal-tree/[visionId]/route.ts"
      provides: "Goal tree API endpoint"
      exports: ["GET"]
    - path: "src/lib/progress/tree.ts"
      provides: "Recursive hierarchy building logic"
      exports: ["buildKpiTree", "KpiTreeNode"]
  key_links:
    - from: "src/app/api/goal-tree/[visionId]/route.ts"
      to: "src/lib/progress/tree.ts"
      via: "import buildKpiTree"
      pattern: "import.*buildKpiTree.*from.*tree"
    - from: "src/lib/progress/tree.ts"
      to: "kpi_progress_cache"
      via: "JOIN for progress data"
      pattern: "kpi_progress_cache"
---

<objective>
Create a single API endpoint that returns the complete KPI hierarchy for a vision with pre-computed progress values.

Purpose: Enable the frontend to fetch the entire goal tree in one call for instant dashboard loads (API-01)
Output: GET /api/goal-tree/{visionId} endpoint returning nested JSON with progress from cache
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 2 delivered the progress infrastructure we'll consume:
@src/lib/progress/types.ts
@src/lib/progress/rollup.ts
@src/lib/progress/ancestor-rollup.ts
@src/lib/progress/index.ts

# Database schema for reference:
@src/lib/db/schema.ts (visionKpis, kpiProgressCache tables)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tree building library</name>
  <files>src/lib/progress/tree.ts</files>
  <action>
Create a new module for building KPI trees from flat database results:

1. Define `KpiTreeNode` interface extending the vision_kpis fields:
   - All existing KPI fields (id, title, level, parentKpiId, etc.)
   - `progress: number` (0-100 from cache)
   - `status: string` (from cache)
   - `childCount: number` (from cache)
   - `children: KpiTreeNode[]` (nested children)
   - `formula?: ProgressFormula` (optional, for transparency)

2. Create `buildKpiTree(flatKpis: FlatKpiWithProgress[]): KpiTreeNode[]` function:
   - Input: flat array of KPIs with their progress cache joined
   - Output: nested tree structure with root nodes (level='quarterly', no parent) at top
   - Algorithm:
     a. Create a Map<id, KpiTreeNode> for O(1) lookup
     b. Initialize each node with empty children array
     c. Iterate flat list, add each node to its parent's children array
     d. Return nodes where parentKpiId is null (root nodes)
   - Sort children by sortOrder at each level

3. Create `FlatKpiWithProgress` type matching the database query result:
   - All vision_kpis columns
   - progress_percentage, status, child_count, completed_child_count from cache

Export types and function from barrel `src/lib/progress/index.ts`.
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit src/lib/progress/tree.ts`
  </verify>
  <done>
KpiTreeNode type and buildKpiTree function exist in tree.ts and are exported from index.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Create goal tree API endpoint</name>
  <files>src/app/api/goal-tree/[visionId]/route.ts</files>
  <action>
Create GET endpoint at /api/goal-tree/[visionId]:

1. Auth: Use standard pattern from existing KPI endpoints
   - createClient() from supabase/server
   - getUserId() helper with DEMO_USER_ID fallback

2. Validation:
   - Verify visionId is valid UUID
   - Verify user owns the vision (or is demo user)

3. Database query - single query with LEFT JOIN:
```sql
SELECT
  vk.id, vk.title, vk.description, vk.level, vk.parent_kpi_id,
  vk.target_value, vk.unit, vk.numeric_target, vk.weight,
  vk.quarter, vk.month, vk.category, vk.tracking_method,
  vk.leads_to, vk.best_time, vk.time_required, vk.why_it_matters,
  vk.sort_order, vk.created_at,
  COALESCE(pc.progress_percentage, 0) as progress_percentage,
  COALESCE(pc.status, 'not_started') as status,
  COALESCE(pc.child_count, 0) as child_count,
  COALESCE(pc.completed_child_count, 0) as completed_child_count,
  pc.calculation_method, pc.last_calculated_at
FROM vision_kpis vk
LEFT JOIN kpi_progress_cache pc ON pc.kpi_id = vk.id
WHERE vk.vision_id = $1 AND vk.is_active = true
ORDER BY vk.level, vk.sort_order
```

4. Transform using buildKpiTree()

5. Response shape:
```json
{
  "visionId": "...",
  "tree": [/* KpiTreeNode[] - root nodes with nested children */],
  "metadata": {
    "totalKpis": number,
    "lastCalculated": "ISO timestamp"
  }
}
```

Use Supabase `.from().select()` syntax, NOT raw SQL. Reference the schema for correct column names (snake_case in DB).
  </action>
  <verify>
1. API returns 200 with nested tree structure
2. Test with curl or browser: GET /api/goal-tree/{test-vision-id}
3. Verify children are properly nested under parents
  </verify>
  <done>
GET /api/goal-tree/{visionId} returns nested KPI hierarchy with progress from cache
  </done>
</task>

<task type="auto">
  <name>Task 3: Update barrel export</name>
  <files>src/lib/progress/index.ts</files>
  <action>
Add exports from tree.ts to the barrel file:

```typescript
// Tree building utilities
export { buildKpiTree, type KpiTreeNode, type FlatKpiWithProgress } from './tree';
```

Ensure all tree-related types are exported for use by the API route and future frontend code.
  </action>
  <verify>
Import from '@/lib/progress' resolves all tree exports: `npx tsc --noEmit`
  </verify>
  <done>
Tree utilities accessible via '@/lib/progress' barrel import
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run build` passes
2. API endpoint accessible: `curl http://localhost:3000/api/goal-tree/{visionId}`
3. Response contains nested tree structure with progress values
4. Empty vision returns empty tree array (not error)
</verification>

<success_criteria>
- GET /api/goal-tree/{visionId} returns full nested JSON hierarchy in one query (API-01)
- Response includes progress percentage from cache for instant dashboard loads
- Tree structure matches KPI parent-child relationships
- Response time under 200ms for typical hierarchy (< 100 KPIs)
</success_criteria>

<output>
After completion, create `.planning/phases/03-tree-fetching-api/03-01-SUMMARY.md`
</output>
