---
phase: 03-tree-fetching-api
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/vision-kpis/[id]/log/route.ts
  - src/lib/progress/ancestor-rollup.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/vision-kpis/{id}/log returns all changed ancestor progress values (not just IDs)"
    - "Response enables frontend to update multiple UI nodes without refetching tree"
    - "Ancestor progress data includes percentage, status, and level"
  artifacts:
    - path: "src/app/api/vision-kpis/[id]/log/route.ts"
      provides: "Enhanced KPI log endpoint with ancestor values"
      exports: ["POST"]
    - path: "src/lib/progress/ancestor-rollup.ts"
      provides: "Rollup function returning ancestor progress values"
      exports: ["rollupProgressToAncestors"]
  key_links:
    - from: "src/app/api/vision-kpis/[id]/log/route.ts"
      to: "src/lib/progress/ancestor-rollup.ts"
      via: "rollupProgressToAncestors call"
      pattern: "rollupProgressToAncestors"
---

<objective>
Enhance the KPI logging endpoint to return full ancestor progress values (not just IDs) after a log entry, enabling optimistic UI updates.

Purpose: Frontend can update all affected progress displays immediately without refetching the tree (API-02)
Output: POST response includes ancestor KPI IDs with their new progress percentages and statuses
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Current implementation to enhance:
@src/app/api/vision-kpis/[id]/log/route.ts
@src/lib/progress/ancestor-rollup.ts

# Phase 2 progress library:
@src/lib/progress/types.ts
@src/lib/progress/rollup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend rollup return type</name>
  <files>src/lib/progress/ancestor-rollup.ts</files>
  <action>
Enhance `rollupProgressToAncestors` to return progress values, not just IDs:

1. Define new return type `AncestorProgressUpdate`:
```typescript
export interface AncestorProgressUpdate {
  kpiId: string;
  level: string;
  title: string;
  progressPercentage: number;
  status: string;
  childCount: number;
  completedChildCount: number;
}
```

2. Modify return type signature:
```typescript
export async function rollupProgressToAncestors(
  supabase: Awaited<ReturnType<typeof createClient>>,
  kpiId: string
): Promise<{
  updatedKpis: AncestorProgressUpdate[];  // Changed from string[]
  duration: number;
  error?: string;
}>
```

3. Update the implementation to collect progress data while traversing:
   - After each ancestor cache update, fetch the new values
   - Build AncestorProgressUpdate object with:
     - kpiId, level, title from vision_kpis
     - progressPercentage, status, childCount, completedChildCount from the calculated result
   - Push to updatedKpis array

4. Include the original KPI (not just ancestors) in the response as the first item

Note: Maintain backward compatibility - the function still updates the cache, just returns richer data.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/lib/progress/ancestor-rollup.ts`
  </verify>
  <done>
rollupProgressToAncestors returns AncestorProgressUpdate[] with full progress data
  </done>
</task>

<task type="auto">
  <name>Task 2: Update log endpoint response</name>
  <files>src/app/api/vision-kpis/[id]/log/route.ts</files>
  <action>
Update the POST response to pass through the enhanced rollup data:

1. The existing code already calls rollupProgressToAncestors and returns:
```typescript
return NextResponse.json({
  log,
  rollup: {
    updatedKpis: rollupResult.updatedKpis,  // Currently string[]
    duration: rollupResult.duration,
  },
});
```

2. Since rollupProgressToAncestors now returns `AncestorProgressUpdate[]`, the response automatically includes:
```json
{
  "log": { /* log entry */ },
  "rollup": {
    "updatedKpis": [
      {
        "kpiId": "...",
        "level": "daily",
        "title": "...",
        "progressPercentage": 100,
        "status": "completed",
        "childCount": 0,
        "completedChildCount": 0
      },
      {
        "kpiId": "...",
        "level": "weekly",
        "title": "...",
        "progressPercentage": 75.5,
        "status": "on_track",
        "childCount": 4,
        "completedChildCount": 3
      }
      // ... up to vision level
    ],
    "duration": 45
  }
}
```

3. If the type change causes any TypeScript issues, update the imports:
```typescript
import { rollupProgressToAncestors, type AncestorProgressUpdate } from '@/lib/progress';
```

No other changes needed - the existing code structure already passes through the rollup result.
  </action>
  <verify>
1. POST /api/vision-kpis/{id}/log returns rollup.updatedKpis as array of objects (not strings)
2. Each object contains kpiId, level, progressPercentage, status
3. Test: `curl -X POST http://localhost:3000/api/vision-kpis/{id}/log -d '{"isCompleted": true}'`
  </verify>
  <done>
POST response includes full ancestor progress data for UI updates without refetch
  </done>
</task>

<task type="auto">
  <name>Task 3: Update types export</name>
  <files>src/lib/progress/index.ts</files>
  <action>
Export the new AncestorProgressUpdate type from the barrel:

```typescript
export {
  rollupProgressToAncestors,
  recalculateParentChain,
  type AncestorProgressUpdate  // Add this
} from './ancestor-rollup';
```

This makes the type available for frontend consumers who will use it to type the API response.
  </action>
  <verify>
Import from '@/lib/progress' resolves AncestorProgressUpdate: `npx tsc --noEmit`
  </verify>
  <done>
AncestorProgressUpdate type exported from barrel for frontend use
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run build` passes
2. POST /api/vision-kpis/{id}/log returns enhanced response
3. rollup.updatedKpis contains objects with kpiId, level, progressPercentage, status
4. First item in updatedKpis is the logged KPI itself
5. Subsequent items are ancestors up to the root
</verification>

<success_criteria>
- POST /api/kpi-logs/{id}/log updates progress and returns all changed ancestor values (API-02)
- Response includes progressPercentage, status, level for each affected KPI
- Frontend can update multiple UI nodes without refetching the tree
- Backward compatible - existing consumers still work (same property names)
</success_criteria>

<output>
After completion, create `.planning/phases/03-tree-fetching-api/03-02-SUMMARY.md`
</output>
