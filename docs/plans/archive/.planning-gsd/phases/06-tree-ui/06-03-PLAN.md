---
phase: 06-tree-ui
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - src/components/features/kpi/goal-tree-view.tsx
  - src/components/features/kpi/goal-tree-node.tsx
  - src/app/(dashboard)/vision/[id]/page.tsx
autonomous: false

must_haves:
  truths:
    - "Tree view shows collapsible nodes that expand/collapse on click"
    - "Each node displays progress bar showing completion percentage"
    - "Status indicators show on-track/at-risk/behind with icon+color"
    - "Breadcrumb shows path from Vision to currently selected item"
    - "Tree limits visible nesting with progressive disclosure"
    - "User can navigate tree using keyboard (Enter/Space, arrows)"
  artifacts:
    - path: "src/components/features/kpi/goal-tree-view.tsx"
      provides: "Main tree view component with full hierarchy"
      exports: ["GoalTreeView"]
    - path: "src/components/features/kpi/goal-tree-node.tsx"
      provides: "Enhanced node with status indicator and keyboard support"
      exports: ["GoalTreeNode"]
  key_links:
    - from: "src/components/features/kpi/goal-tree-view.tsx"
      to: "src/lib/hooks/use-goal-tree.ts"
      via: "useGoalTree hook for data fetching"
      pattern: "useGoalTree"
    - from: "src/components/features/kpi/goal-tree-view.tsx"
      to: "src/lib/hooks/use-kpi-mutations.ts"
      via: "useLogKpi hook for completion"
      pattern: "useLogKpi"
    - from: "src/app/(dashboard)/vision/[id]/page.tsx"
      to: "src/components/features/kpi/goal-tree-view.tsx"
      via: "Replaces KpiTreeWidget"
      pattern: "GoalTreeView"
---

<objective>
Create the main GoalTreeView component integrating all parts: context, nodes, status indicators, breadcrumb, keyboard navigation, and progressive disclosure. Then integrate it into the Vision detail page.

Purpose: Delivers the complete accessible tree UI (TREE-01 through TREE-06 requirements) that users can navigate to see their full goal hierarchy with progress tracking.

Output: GoalTreeView component replacing the flat KpiTreeWidget, with full ARIA tree view support and keyboard navigation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-tree-ui/06-RESEARCH.md
@.planning/phases/06-tree-ui/06-01-SUMMARY.md
@.planning/phases/06-tree-ui/06-02-SUMMARY.md

# Components from previous plans
@src/components/features/kpi/goal-tree-context.tsx
@src/components/features/kpi/goal-tree-node.tsx
@src/components/features/kpi/goal-tree-breadcrumb.tsx
@src/components/features/kpi/status-indicator.tsx

# Existing implementation to replace
@src/components/features/kpi/kpi-tree-widget.tsx

# Page to update
@src/app/(dashboard)/vision/[id]/page.tsx

# Hooks
@src/lib/hooks/use-goal-tree.ts
@src/lib/hooks/use-kpi-mutations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance GoalTreeNode with status indicator and keyboard support</name>
  <files>src/components/features/kpi/goal-tree-node.tsx</files>
  <action>
Enhance the GoalTreeNode component from Plan 06-01 to include:

1. **Status indicator integration:**
   - Import StatusIndicator from './status-indicator'
   - Add StatusIndicator after the title: `<StatusIndicator status={node.status} size="sm" />`
   - Show status indicator inline with title

2. **Progressive disclosure (TREE-05):**
   - Add a `maxVisibleChildren` constant (default: 10)
   - When children count exceeds maxVisibleChildren and not all shown:
     ```tsx
     const [showAll, setShowAll] = useState(false);
     const visibleChildren = showAll ? node.children : node.children.slice(0, maxVisibleChildren);
     const hiddenCount = node.children.length - maxVisibleChildren;

     // After visible children, if there are more:
     {!showAll && hiddenCount > 0 && (
       <li className="py-1 px-2">
         <Button
           variant="ghost"
           size="sm"
           className="text-xs text-muted-foreground"
           onClick={() => setShowAll(true)}
         >
           Show {hiddenCount} more...
         </Button>
       </li>
     )}
     ```

3. **Checkbox for leaf nodes:**
   - Only show checkbox if `!hasChildren` (leaf node)
   - Pass the onLogKpi callback through: `onClick={() => onLogKpi?.(node.id, node.progress < 100)}`
   - Use Checkbox component with `checked={node.progress >= 100}`

4. **Enhanced focus styles:**
   - When `isFocused`: `ring-2 ring-ring ring-offset-2 ring-offset-background`
   - When `isSelected`: `bg-accent`

5. **Keyboard event handler on the `<li>` element:**
   ```tsx
   onKeyDown={(e) => {
     if (e.key === 'Enter' || e.key === ' ') {
       e.preventDefault();
       if (hasChildren) {
         toggleExpanded(node.id);
       } else {
         // Log leaf node
         onLogKpi?.(node.id, node.progress < 100);
       }
     }
   }}
   ```
   Note: Arrow key navigation is handled at the tree level (Task 2), not individual nodes.
  </action>
  <verify>
TypeScript compilation passes:
```bash
npx tsc --noEmit src/components/features/kpi/goal-tree-node.tsx
```
  </verify>
  <done>GoalTreeNode includes status indicator, progressive disclosure for large children lists, leaf node checkboxes, and Enter/Space keyboard handling.</done>
</task>

<task type="auto">
  <name>Task 2: Create GoalTreeView main component</name>
  <files>src/components/features/kpi/goal-tree-view.tsx</files>
  <action>
Create the main tree view component that orchestrates all the pieces.

Props:
```typescript
interface GoalTreeViewProps {
  visionId: string;
  visionTitle: string;
}
```

Implementation:

1. **Mark as 'use client'**

2. **Data fetching:**
   ```typescript
   const { data, isLoading, error, refetch, isUpdating } = useGoalTree(visionId);
   const { mutate: logKpi, isLoggingKpi } = useLogKpi(visionId, {
     onError: (err) => toast.error(`Failed to update: ${err.message}`),
   });
   ```

3. **Calculate default expanded IDs:**
   - On initial load, expand first 2 levels by default
   ```typescript
   const defaultExpanded = useMemo(() => {
     if (!data?.tree) return [];
     const ids: string[] = [];
     function collectLevel(nodes: KpiTreeNode[], depth: number) {
       for (const node of nodes) {
         if (depth <= 2) {
           ids.push(node.id);
           if (node.children?.length) {
             collectLevel(node.children, depth + 1);
           }
         }
       }
     }
     collectLevel(data.tree, 1);
     return ids;
   }, [data?.tree]);
   ```

4. **Breadcrumb path derivation:**
   ```typescript
   const [selectedId, setSelectedId] = useState<string | null>(null);
   const breadcrumbPath = useMemo(
     () => deriveBreadcrumbPath(selectedId, data?.tree ?? [], visionTitle),
     [selectedId, data?.tree, visionTitle]
   );
   ```

5. **Keyboard navigation hook (roving tabindex):**
   Create a ref for the tree container and handle arrow keys:
   ```typescript
   const treeRef = useRef<HTMLUListElement>(null);
   const [focusedId, setFocusedId] = useState<string | null>(null);

   useEffect(() => {
     const tree = treeRef.current;
     if (!tree) return;

     const handleKeyDown = (e: KeyboardEvent) => {
       const items = Array.from(tree.querySelectorAll('[role="treeitem"]'));
       const currentIndex = items.findIndex(
         item => item.getAttribute('data-id') === focusedId
       );

       let nextIndex = currentIndex;

       switch (e.key) {
         case 'ArrowDown':
           e.preventDefault();
           nextIndex = Math.min(currentIndex + 1, items.length - 1);
           break;
         case 'ArrowUp':
           e.preventDefault();
           nextIndex = Math.max(currentIndex - 1, 0);
           break;
         case 'Home':
           e.preventDefault();
           nextIndex = 0;
           break;
         case 'End':
           e.preventDefault();
           nextIndex = items.length - 1;
           break;
         default:
           return;
       }

       if (nextIndex !== currentIndex && items[nextIndex]) {
         const newId = items[nextIndex].getAttribute('data-id');
         if (newId) {
           setFocusedId(newId);
           (items[nextIndex] as HTMLElement).focus();
         }
       }
     };

     tree.addEventListener('keydown', handleKeyDown);
     return () => tree.removeEventListener('keydown', handleKeyDown);
   }, [focusedId]);
   ```

6. **Loading state:**
   Show Skeleton loader similar to KpiTreeWidget

7. **Error state:**
   Show error with retry button

8. **Empty state:**
   Show message when tree is empty with CTA to generate KPIs

9. **Main render structure:**
   ```tsx
   <GoalTreeProvider
     tree={data?.tree ?? []}
     visionTitle={visionTitle}
     defaultExpanded={defaultExpanded}
   >
     <div className="space-y-4">
       {/* Breadcrumb navigation */}
       <GoalTreeBreadcrumb
         path={breadcrumbPath}
         onNavigate={(id) => {
           if (id === 'vision') {
             setSelectedId(null);
           } else {
             setSelectedId(id);
             // Scroll to and focus the node
             const node = treeRef.current?.querySelector(`[data-id="${id}"]`);
             if (node) {
               (node as HTMLElement).focus();
               node.scrollIntoView({ behavior: 'smooth', block: 'center' });
             }
           }
         }}
       />

       {/* Updating indicator */}
       {(isUpdating || isLoggingKpi) && (
         <div className="flex items-center gap-2 text-xs text-muted-foreground">
           <Loader2 className="h-3 w-3 animate-spin" />
           Updating...
         </div>
       )}

       {/* Tree */}
       <ul
         ref={treeRef}
         role="tree"
         aria-label={`${visionTitle} goal hierarchy`}
         className="space-y-1"
       >
         {data.tree.map((node, index) => (
           <GoalTreeNode
             key={node.id}
             node={node}
             level={1}
             posInSet={index + 1}
             setSize={data.tree.length}
             onLogKpi={(kpiId, isCompleted) => {
               logKpi({ kpiId, isCompleted });
             }}
           />
         ))}
       </ul>

       {/* Metadata footer */}
       {data?.metadata && (
         <div className="text-xs text-muted-foreground pt-2 border-t">
           {data.metadata.totalKpis} KPIs
           {data.metadata.lastCalculated && (
             <span className="ml-2">
               | Last updated: {new Date(data.metadata.lastCalculated).toLocaleTimeString()}
             </span>
           )}
         </div>
       )}
     </div>
   </GoalTreeProvider>
   ```

Import from:
- `react` for useState, useMemo, useEffect, useRef
- `lucide-react` for Loader2, AlertCircle, RefreshCw
- `sonner` for toast
- `@/lib/hooks` for useGoalTree, useLogKpi
- `@/lib/progress` for KpiTreeNode
- `@/components/ui/skeleton` for Skeleton
- `@/components/ui/button` for Button
- `./goal-tree-context` for GoalTreeProvider
- `./goal-tree-node` for GoalTreeNode
- `./goal-tree-breadcrumb` for GoalTreeBreadcrumb, deriveBreadcrumbPath
  </action>
  <verify>
TypeScript compilation passes:
```bash
npx tsc --noEmit src/components/features/kpi/goal-tree-view.tsx
```
  </verify>
  <done>GoalTreeView component integrates context, nodes, breadcrumb, keyboard navigation, and hooks for a complete accessible tree UI.</done>
</task>

<task type="auto">
  <name>Task 3: Replace KpiTreeWidget with GoalTreeView on Vision detail page</name>
  <files>src/app/(dashboard)/vision/[id]/page.tsx</files>
  <action>
Update the Vision detail page to use the new GoalTreeView component:

1. **Update imports:**
   - Remove: `import { KpiTreeWidget } from '@/components/features/kpi/kpi-tree-widget';`
   - Add: `import { GoalTreeView } from '@/components/features/kpi/goal-tree-view';`

2. **Replace in the KPIs tab (around line 1030-1040):**
   Find this block:
   ```tsx
   <Card>
     <CardContent className="pt-6">
       <h3 className="font-semibold flex items-center gap-2 mb-4">
         <Target className="h-5 w-5 text-primary" />
         KPI Progress Tree
       </h3>
       <KpiTreeWidget visionId={id} />
     </CardContent>
   </Card>
   ```

   Replace with:
   ```tsx
   <Card>
     <CardContent className="pt-6">
       <h3 className="font-semibold flex items-center gap-2 mb-4">
         <Target className="h-5 w-5 text-primary" />
         KPI Progress Tree
       </h3>
       <GoalTreeView visionId={id} visionTitle={vision.title} />
     </CardContent>
   </Card>
   ```

The KpiTreeWidget file can remain in the codebase for reference but is no longer used.
  </action>
  <verify>
1. Import changed:
```bash
grep -E "import.*GoalTreeView" "src/app/(dashboard)/vision/[id]/page.tsx"
```
2. No more KpiTreeWidget usage:
```bash
grep -c "KpiTreeWidget" "src/app/(dashboard)/vision/[id]/page.tsx" || echo "Not found (good)"
```
3. TypeScript compilation:
```bash
npx tsc --noEmit "src/app/(dashboard)/vision/[id]/page.tsx"
```
  </verify>
  <done>Vision detail page uses GoalTreeView with full tree functionality.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete goal tree UI with:
- Collapsible nodes using Radix Collapsible
- Progress bars on each node
- Status indicators with icon+color (on-track/at-risk/behind)
- Breadcrumb navigation from Vision to selected node
- Progressive disclosure (shows first 10 children, "Show more" for rest)
- Keyboard navigation (Arrow Up/Down, Enter/Space to expand, Home/End)
  </what-built>
  <how-to-verify>
1. Start the dev server if not running: `npm run dev`
2. Navigate to http://localhost:3000/vision
3. Click "View" on any vision that has KPIs generated
4. Click on the "KPIs" tab
5. Verify the tree view:
   - [ ] Nodes have expand/collapse chevrons
   - [ ] Clicking chevron expands/collapses children
   - [ ] Each node shows progress bar with percentage
   - [ ] Status badges appear with icons (check/warning/circle)
   - [ ] Breadcrumb appears at top showing "Vision Name"
   - [ ] Clicking a node updates breadcrumb to show full path
   - [ ] Clicking breadcrumb items navigates back
6. Test keyboard navigation:
   - [ ] Click on a node to focus it
   - [ ] Arrow Down moves to next node
   - [ ] Arrow Up moves to previous node
   - [ ] Enter or Space toggles expand/collapse
   - [ ] Home jumps to first node
   - [ ] End jumps to last node
7. Test progressive disclosure (if tree has >10 children at any level):
   - [ ] Shows "Show N more..." button
   - [ ] Clicking reveals hidden children
8. Test completion (on leaf nodes):
   - [ ] Checkbox appears only on leaf nodes
   - [ ] Clicking checkbox marks complete with optimistic update
   - [ ] Progress rolls up to parent nodes
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. All files compile:
```bash
npx tsc --noEmit src/components/features/kpi/goal-tree-view.tsx src/components/features/kpi/goal-tree-node.tsx "src/app/(dashboard)/vision/[id]/page.tsx"
```
2. GoalTreeView exports:
```bash
grep "export.*GoalTreeView" src/components/features/kpi/goal-tree-view.tsx
```
3. Tree ARIA attributes present:
```bash
grep -E 'role="tree"|role="treeitem"' src/components/features/kpi/goal-tree-view.tsx src/components/features/kpi/goal-tree-node.tsx
```
</verification>

<success_criteria>
- GoalTreeView integrates all components from Plans 01 and 02
- Tree renders with proper ARIA tree role structure
- Keyboard navigation works (Arrow keys, Enter/Space, Home/End)
- Breadcrumb shows path and allows navigation
- Status indicators display with icons and colors
- Progressive disclosure limits visible children
- Leaf nodes have completion checkboxes
- Vision detail page uses GoalTreeView instead of KpiTreeWidget
- Human verification confirms all features work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/06-tree-ui/06-03-SUMMARY.md`
</output>
