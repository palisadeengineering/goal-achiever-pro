---
phase: 05-cascade-generation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/vision-kpis/route.ts
  - src/lib/hooks/use-kpi-mutations.ts
autonomous: true

must_haves:
  truths:
    - "User can manually add custom KPIs to hierarchy via API"
    - "User can create root-level KPIs (no parent)"
    - "User can link new KPIs to existing parents"
    - "Created KPIs appear in the goal tree immediately after page refresh"
  artifacts:
    - path: "src/app/api/vision-kpis/route.ts"
      provides: "POST endpoint for manual KPI creation with validation"
      exports: ["POST"]
    - path: "src/lib/hooks/use-kpi-mutations.ts"
      provides: "useCreateKpi mutation hook"
      contains: "useCreateKpi"
  key_links:
    - from: "src/lib/hooks/use-kpi-mutations.ts"
      to: "/api/vision-kpis"
      via: "fetch POST"
      pattern: "fetch.*api/vision-kpis"
    - from: "src/lib/hooks/use-kpi-mutations.ts"
      to: "goalTreeKeys.tree"
      via: "invalidateQueries on success"
      pattern: "invalidateQueries.*goalTreeKeys\\.tree"
---

<objective>
Enhance existing vision-kpis endpoint and add React mutation hook for manual KPI creation with parent linkage.

Purpose: Users need to manually create KPIs and link them to existing parents in the hierarchy. This enables:
- Creating custom KPIs that AI didn't generate
- Linking new KPIs to any level in the hierarchy
- Building custom sub-hierarchies under existing KPIs

**Note:** The POST /api/vision-kpis endpoint already exists with basic bulk creation. This plan enhances it with:
- Vision ownership verification
- Parent KPI validation (must be same vision)
- Progress cache initialization
- Parent child_count update

Output: Enhanced POST /api/vision-kpis endpoint + useCreateKpi mutation hook
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/api/vision-kpis/route.ts (existing endpoint to enhance)
@src/lib/hooks/use-kpi-mutations.ts (existing mutations to extend)
@src/lib/hooks/query-keys.ts (query key factory)
@src/lib/db/schema.ts (vision_kpis table)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance existing POST endpoint with validation and cache initialization</name>
  <files>src/app/api/vision-kpis/route.ts</files>
  <action>
The POST endpoint at `src/app/api/vision-kpis/route.ts` already exists with basic functionality. Enhance it with:

1. **Verify vision ownership before creating KPIs:**
```typescript
// For single KPI creation (non-array body), verify vision belongs to user
if (!Array.isArray(body) && body.visionId) {
  const { data: vision, error: visionError } = await supabase
    .from('visions')
    .select('id')
    .eq('id', body.visionId)
    .eq('user_id', userId)
    .single();

  if (visionError || !vision) {
    return NextResponse.json({ error: 'Vision not found or access denied' }, { status: 404 });
  }
}
```

2. **If parentKpiId provided, verify it exists and belongs to same vision:**
```typescript
if (!Array.isArray(body) && body.parentKpiId) {
  const { data: parentKpi, error: parentError } = await supabase
    .from('vision_kpis')
    .select('id, vision_id')
    .eq('id', body.parentKpiId)
    .single();

  if (parentError || !parentKpi) {
    return NextResponse.json({ error: 'Parent KPI not found' }, { status: 404 });
  }

  if (parentKpi.vision_id !== body.visionId) {
    return NextResponse.json(
      { error: 'Parent KPI must belong to the same vision' },
      { status: 400 }
    );
  }
}
```

3. **After successful creation, initialize progress cache for each created KPI:**
```typescript
if (kpis && kpis.length > 0) {
  // Initialize progress cache for each KPI
  const cacheEntries = kpis.map(kpi => ({
    kpi_id: kpi.id,
    current_value: 0,
    target_value: kpi.numeric_target || null,
    progress_percentage: 0,
    child_count: 0,
    completed_child_count: 0,
    weighted_progress: 0,
    total_weight: 1,
    status: 'not_started',
    calculation_method: 'auto',
    last_calculated_at: new Date().toISOString(),
  }));

  await supabase
    .from('kpi_progress_cache')
    .upsert(cacheEntries, { onConflict: 'kpi_id' });

  // Update parent child_count if any KPIs have parents
  const parentsToUpdate = kpis
    .filter(kpi => kpi.parent_kpi_id)
    .map(kpi => kpi.parent_kpi_id);

  for (const parentId of new Set(parentsToUpdate)) {
    const { data: parentCache } = await supabase
      .from('kpi_progress_cache')
      .select('child_count')
      .eq('kpi_id', parentId)
      .single();

    if (parentCache) {
      const increment = parentsToUpdate.filter(p => p === parentId).length;
      await supabase
        .from('kpi_progress_cache')
        .update({
          child_count: (parentCache.child_count || 0) + increment,
          last_calculated_at: new Date().toISOString(),
        })
        .eq('kpi_id', parentId);
    }
  }
}
```

4. **Add weight field support:**
Ensure the insert includes `weight: kpi.weight || 1` in the mapping.
  </action>
  <verify>
1. Read src/app/api/vision-kpis/route.ts
2. Confirm vision ownership verification exists for single-KPI creation
3. Confirm parent KPI validation exists
4. Confirm progress cache initialization after insert
5. Confirm parent child_count update logic
6. Run `npx tsc --noEmit`
  </verify>
  <done>
POST /api/vision-kpis endpoint enhanced with:
- Vision ownership verification
- Parent KPI validation (same vision)
- Progress cache initialization for all created KPIs
- Parent child_count update
- Weight field support
  </done>
</task>

<task type="auto">
  <name>Task 2: Add useCreateKpi mutation hook</name>
  <files>src/lib/hooks/use-kpi-mutations.ts, src/lib/hooks/index.ts</files>
  <action>
Add useCreateKpi mutation to the existing use-kpi-mutations.ts file.

**In use-kpi-mutations.ts, add:**

1. Add CreateKpiInput type:
```typescript
export interface CreateKpiInput {
  visionId: string;
  title: string;
  description?: string;
  level: 'quarterly' | 'monthly' | 'weekly' | 'daily';
  parentKpiId?: string | null;
  targetValue?: string;
  unit?: string;
  numericTarget?: number;
  weight?: number;
  quarter?: number;
  month?: number;
}
```

2. Add useCreateKpi hook:
```typescript
/**
 * Mutation hook for creating a new KPI manually.
 * Invalidates goal tree query on success to show new KPI.
 */
export function useCreateKpi(visionId: string | undefined) {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (input: CreateKpiInput) => {
      const response = await fetch('/api/vision-kpis', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(input),
      });

      if (!response.ok) {
        const data = await response.json().catch(() => ({}));
        throw new Error(data.error || 'Failed to create KPI');
      }

      return response.json();
    },
    onSuccess: () => {
      // Invalidate goal tree to show new KPI immediately
      if (visionId) {
        queryClient.invalidateQueries({ queryKey: goalTreeKeys.tree(visionId) });
      }
    },
  });
}
```

**In index.ts, add export:**
```typescript
export { useCreateKpi, type CreateKpiInput } from './use-kpi-mutations';
```
  </action>
  <verify>
1. useCreateKpi function exists in use-kpi-mutations.ts
2. CreateKpiInput type is exported
3. Hook invalidates goalTreeKeys.tree(visionId) on success specifically
4. Barrel export includes useCreateKpi
5. Run `npx tsc --noEmit`
  </verify>
  <done>
useCreateKpi mutation hook added:
- CreateKpiInput type defined
- Hook calls POST /api/vision-kpis
- Invalidates goalTreeKeys.tree(visionId) on success (ensures created KPIs appear immediately)
- Exported from hooks barrel
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. POST endpoint validates vision ownership and parent KPI
3. POST endpoint initializes progress cache
4. useCreateKpi hook exists and is exported
5. Hook invalidates goalTreeKeys.tree(visionId) on success (verify pattern in code)
</verification>

<success_criteria>
1. POST /api/vision-kpis validates vision ownership and parent KPI
2. Endpoint initializes progress cache for new KPIs
3. Endpoint updates parent child_count when creating child KPIs
4. useCreateKpi mutation hook calls endpoint
5. Hook invalidates goal tree query on success (goalTreeKeys.tree pattern)
6. Types are properly exported
7. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-cascade-generation/05-02-SUMMARY.md`
</output>
